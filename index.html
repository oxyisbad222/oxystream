<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyeMovie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #141414;
            color: #e5e5e5;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #232323; }
        ::-webkit-scrollbar-thumb { background: #e50914; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f40612; }

        .netflix-red-text { color: #e50914; }
        .input-field, .select-field {
            background-color: #333; border: 1px solid #555; color: #fff;
            border-radius: 0.25rem; padding: 0.5rem 0.75rem;
            transition: border-color 0.2s ease-in-out; width: 100%;
        }
        .input-field:focus, .select-field:focus { outline: none; border-color: #e50914; }
        
        .card {
            background-color: #1f1f1f; border-radius: 0.5rem;
            overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            width: 180px; 
            flex-shrink: 0; 
        }
        .card:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .card img { width: 100%; height: 270px; object-fit: cover; }
        
        .iframe-container { position: relative; overflow: hidden; width: 100%; padding-top: 56.25%; background-color: #000; }
        .iframe-container iframe { position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%; border: none; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); }
        .modal-content { background-color: #181818; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 900px; }
        .close-button { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close-button:hover, .close-button:focus { color: #e50914; text-decoration: none; }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #e50914;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .horizontal-scroll-container {
            position: relative;
        }
        .scroll-wrapper {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding-bottom: 1rem; 
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        .scroll-wrapper::-webkit-scrollbar {
            display: none; 
        }
        .scroll-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            padding: 0.8rem 0.5rem; 
            cursor: pointer;
            z-index: 10;
            border-radius: 0.25rem;
            font-size: 1.5rem; 
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .scroll-button:hover { opacity: 1; }
        .scroll-button.prev { left: 5px; }
        .scroll-button.next { right: 5px; }
        .scroll-button:disabled { opacity:0.3; cursor: not-allowed;}

        #modalTvControls {
            background-color: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
        }
        .btn-next-episode {
            background-color: #e50914; color: white; font-weight: bold;
            padding: 0.5rem 1rem; border-radius: 0.25rem;
            transition: background-color 0.2s ease-in-out; cursor: pointer;
            border: none;
        }
        .btn-next-episode:hover { background-color: #f40612; }
        .btn-next-episode:disabled { background-color: #555; cursor: not-allowed; }

    </style>
</head>
<body class="text-gray-200">

    <header class="bg-black bg-opacity-90 shadow-lg sticky top-0 z-50 backdrop-blur-md">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <a href="#" id="homeLink" class="text-3xl font-bold netflix-red-text">SkyeMovie</a>
                <div class="flex-grow max-w-xl mx-4">
                    <div class="relative">
                        <input type="text" id="searchInput" class="input-field w-full pr-10" placeholder="Search movies or TV shows...">
                        <button id="searchButton" class="absolute inset-y-0 right-0 px-3 text-gray-400 hover:text-e50914">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="md:hidden">
                    <button id="mobileMenuButton" class="text-gray-300 hover:text-white focus:outline-none">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobileMenu" class="md:hidden hidden bg-black bg-opacity-90">
            <a href="#" id="navDiscoverMobile" class="block text-center py-3 border-b border-gray-700 hover:bg-gray-700">Discover</a>
        </div>
    </header>
    
    <main class="container mx-auto p-4 sm:p-6 lg:p-8" id="mainContent">
        <div id="statusMessage" class="text-center my-4 h-6"></div>
        <section id="discoverSection">
            <h2 class="text-3xl font-bold mb-6 border-l-4 border-red-600 pl-3">Most Popular</h2>
            
            <div id="discoverGridMovies" class="mb-10">
                <h3 class="text-2xl font-semibold mb-4">Movies</h3>
                <div class="horizontal-scroll-container">
                    <button class="scroll-button prev" data-target="moviesScrollWrapper"><i class="fas fa-chevron-left"></i></button>
                    <div id="moviesScrollWrapper" class="scroll-wrapper flex space-x-4">
                    </div>
                    <button class="scroll-button next" data-target="moviesScrollWrapper"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <div id="discoverGridTV">
                <h3 class="text-2xl font-semibold mb-4">TV Shows</h3>
                 <div class="horizontal-scroll-container">
                    <button class="scroll-button prev" data-target="tvScrollWrapper"><i class="fas fa-chevron-left"></i></button>
                    <div id="tvScrollWrapper" class="scroll-wrapper flex space-x-4">
                    </div>
                    <button class="scroll-button next" data-target="tvScrollWrapper"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </section>
    </main>

    <div id="playerModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-2">
                <h3 id="playerModalTitle" class="text-xl font-semibold">Now Playing</h3>
                <span class="close-button" id="closeModalButton">&times;</span>
            </div>
            <div id="playerContainer" class="iframe-container"></div>
            
            <div id="modalTvControls" class="hidden mt-4">
                <h4 id="modalTvShowTitle" class="text-md font-semibold mb-2"></h4>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-center">
                    <div class="flex items-center gap-2">
                        <label for="modalSeasonSelect" class="text-sm flex-shrink-0">Season:</label>
                        <select id="modalSeasonSelect" class="select-field text-sm"></select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="modalEpisodeSelect" class="text-sm flex-shrink-0">Episode:</label>
                        <select id="modalEpisodeSelect" class="select-field text-sm"></select>
                    </div>
                    <button id="nextEpisodeButton" class="btn-next-episode text-sm sm:col-start-3">Next Episode <i class="fas fa-step-forward ml-1"></i></button>
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-3">Using Server 4. If player doesn't load, ID might not be compatible or available. Sandboxing is active to prevent popups/redirects, which might affect some player features.</p>
        </div>
    </div>

    <footer class="text-center p-6 mt-12 border-t border-gray-700">
        <p class="text-sm text-gray-500">&copy; <span id="currentYear"></span> SkyeMovie. Uses TMDB API.</p>
        <p class="text-xs text-gray-600 mt-1">This product uses the TMDB API but is not endorsed or certified by TMDB.</p>
    </footer>

    <script>
        const TMDB_IMG_BASE_URL = 'https://image.tmdb.org/t/p/w500';
        const ANYEMBED_BASE_URL = "https://player.autoembed.cc/embed";
        const DEFAULT_SERVER = 4;

        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const statusMessage = document.getElementById('statusMessage');
        
        const playerModal = document.getElementById('playerModal');
        const playerContainer = document.getElementById('playerContainer');
        const closeModalButton = document.getElementById('closeModalButton');
        const playerModalTitle = document.getElementById('playerModalTitle');

        const modalTvControls = document.getElementById('modalTvControls');
        const modalTvShowTitleEl = document.getElementById('modalTvShowTitle');
        const modalSeasonSelect = document.getElementById('modalSeasonSelect');
        const modalEpisodeSelect = document.getElementById('modalEpisodeSelect');
        const nextEpisodeButton = document.getElementById('nextEpisodeButton');

        const discoverSection = document.getElementById('discoverSection');
        let moviesScrollWrapper = document.getElementById('moviesScrollWrapper'); 
        let tvScrollWrapper = document.getElementById('tvScrollWrapper'); 
        
        const homeLink = document.getElementById('homeLink');
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');
        const navDiscoverMobile = document.getElementById('navDiscoverMobile');

        let currentTvShow = {
            id: null,
            name: null,
            season: 1,
            episode: 1,
            totalSeasons: 0,
            episodesInCurrentSeason: []
        };
        let seasonDetailsCache = {}; 

        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'text-center my-4 h-6 ';
            if (type === 'error') statusMessage.classList.add('text-red-400');
            else if (type === 'success') statusMessage.classList.add('text-green-400');
            else statusMessage.classList.add('text-gray-400');
        }

        function createLoadingSpinner() {
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner'; 
            return spinner;
        }

        async function fetchFromTMDB(tmdbEndpoint, tmdbParams = {}) {
            const proxyUrlParams = new URLSearchParams({
                endpoint: tmdbEndpoint,
                ...tmdbParams
            });
            const proxyUrl = `/api/tmdb-proxy?${proxyUrlParams.toString()}`;

            try {
                const response = await fetch(proxyUrl);
                const contentType = response.headers.get("content-type");

                if (!response.ok) {
                    let errorPayload = { 
                        message: `Proxy API Error: ${response.status} ${response.statusText}`,
                        status: response.status,
                        contentType: contentType
                    };
                    if (contentType && contentType.includes("application/json")) {
                        const errorData = await response.json().catch(() => ({}));
                        errorPayload.details = errorData.error || errorData.details || errorData.message || errorData;
                    } else {
                        errorPayload.rawResponse = await response.text().catch(() => "Could not read error response body.");
                    }
                    console.error("Proxy Error Payload:", errorPayload);
                    throw new Error(typeof errorPayload.details === 'string' ? errorPayload.details : errorPayload.message);
                }

                if (contentType && contentType.includes("application/json")) {
                    return await response.json();
                } else {
                    const rawText = await response.text().catch(() => "Could not read response body.");
                    console.error("Expected JSON response from proxy, but received:", contentType, rawText.substring(0, 200));
                    throw new Error(`Unexpected content type from proxy: ${contentType}. Expected JSON. Received: ${rawText.substring(0,100)}...`);
                }

            } catch (error) {
                console.error('Full error in fetchFromTMDB:', error);
                showStatus(error.message || "An unknown API error occurred.", 'error');
                throw error; 
            }
        }


        async function searchTMDB(query) {
            showStatus('');
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = ''; 
            const spinner = createLoadingSpinner();
            spinner.classList.add('mx-auto', 'my-10'); 
            mainContent.appendChild(spinner);

            try {
                const data = await fetchFromTMDB('search/multi', { query });
                mainContent.innerHTML = ''; 

                if (data.results && data.results.length > 0) {
                    const firstResult = data.results.find(r => r.media_type === 'movie' || r.media_type === 'tv');
                    if (firstResult) {
                        if (firstResult.media_type === 'movie') {
                            playMovie(firstResult.id, firstResult.title || firstResult.original_name);
                        } else if (firstResult.media_type === 'tv') {
                            currentTvShow.id = firstResult.id;
                            currentTvShow.name = firstResult.name || firstResult.original_name;
                            currentTvShow.season = 1;
                            currentTvShow.episode = 1;
                            await updateAndShowTVControlsInModal();
                            playTvShow();
                        }
                        mainContent.appendChild(discoverSection); 
                        reinitializeScrollableContent(); 
                        loadPopularContent(); 
                    } else {
                        showStatus('No relevant movie or TV show found.', 'info');
                        mainContent.appendChild(discoverSection);
                        reinitializeScrollableContent();
                        loadPopularContent();
                    }
                } else {
                    showStatus(`No results found for "${query}".`, 'info');
                    mainContent.appendChild(discoverSection);
                    reinitializeScrollableContent();
                    loadPopularContent();
                }
            } catch (error) {
                mainContent.innerHTML = ''; 
                mainContent.appendChild(discoverSection); 
                reinitializeScrollableContent();
                loadPopularContent();
            }
        }
        
        async function loadPopularContent() {
            showStatus('');
            if (!moviesScrollWrapper || !tvScrollWrapper) {
                reinitializeScrollableContent(); 
                if (!moviesScrollWrapper || !tvScrollWrapper) { 
                     showStatus("UI elements missing. Please refresh.", "error");
                     return;
                }
            }
            moviesScrollWrapper.innerHTML = ''; 
            tvScrollWrapper.innerHTML = '';
            const movieSpinner = createLoadingSpinner();
            const tvSpinner = createLoadingSpinner();
            moviesScrollWrapper.appendChild(movieSpinner);
            tvScrollWrapper.appendChild(tvSpinner);
            updateScrollButtons(moviesScrollWrapper);
            updateScrollButtons(tvScrollWrapper);

            try {
                const [moviesData, tvData] = await Promise.all([
                    fetchFromTMDB('movie/popular'),
                    fetchFromTMDB('tv/popular')
                ]);

                moviesScrollWrapper.innerHTML = '';
                if (moviesData.results && moviesData.results.length > 0) {
                    moviesData.results.forEach(movie => moviesScrollWrapper.appendChild(createContentCard(movie, 'movie')));
                } else {
                     moviesScrollWrapper.innerHTML = '<p class="text-center p-4">Could not load popular movies.</p>';
                }
                updateScrollButtons(moviesScrollWrapper);

                tvScrollWrapper.innerHTML = '';
                if (tvData.results && tvData.results.length > 0) {
                    tvData.results.forEach(tvShow => tvScrollWrapper.appendChild(createContentCard(tvShow, 'tv')));
                } else {
                    tvScrollWrapper.innerHTML = '<p class="text-center p-4">Could not load popular TV shows.</p>';
                }
                updateScrollButtons(tvScrollWrapper);

            } catch (error) {
                 if (!moviesScrollWrapper.hasChildNodes() || moviesScrollWrapper.firstChild.classList.contains('loading-spinner')) {
                    moviesScrollWrapper.innerHTML = `<p class="text-center p-4 text-red-400">Error loading movies.</p>`;
                 }
                 if (!tvScrollWrapper.hasChildNodes() || tvScrollWrapper.firstChild.classList.contains('loading-spinner')) {
                    tvScrollWrapper.innerHTML = `<p class="text-center p-4 text-red-400">Error loading TV shows.</p>`;
                 }
            }
        }

        function createContentCard(item, type) {
            const card = document.createElement('div');
            card.className = 'card';
            const title = type === 'movie' ? (item.title || item.original_name) : (item.name || item.original_name);
            const posterPath = item.poster_path ? `${TMDB_IMG_BASE_URL}${item.poster_path}` : 'https://placehold.co/180x270/1f1f1f/e50914?text=No+Poster';
            
            card.innerHTML = `
                <img src="${posterPath}" alt="${title} Poster" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/180x270/1f1f1f/e50914?text=Error';">
                <div class="p-2">
                    <h4 class="font-semibold truncate text-sm" title="${title}">${title}</h4>
                    <p class="text-xs text-gray-400">${type === 'movie' ? 'Movie' : 'TV Show'}</p>
                </div>
            `;
            card.addEventListener('click', () => {
                if (type === 'movie') {
                    playMovie(item.id, title);
                } else {
                    currentTvShow.id = item.id;
                    currentTvShow.name = title;
                    currentTvShow.season = 1; 
                    currentTvShow.episode = 1;
                    updateAndShowTVControlsInModal();
                    playTvShow(); 
                }
            });
            return card;
        }
        
        async function updateAndShowTVControlsInModal() {
            if (!currentTvShow.id) {
                modalTvControls.classList.add('hidden');
                return;
            }

            modalTvShowTitleEl.textContent = currentTvShow.name || 'Selected TV Show';
            modalTvControls.classList.remove('hidden');

            modalSeasonSelect.disabled = true;
            modalEpisodeSelect.disabled = true;
            modalSeasonSelect.innerHTML = '<option>Loading...</option>';
            modalEpisodeSelect.innerHTML = '<option>Loading...</option>';
            nextEpisodeButton.disabled = true;

            try {
                const tvDetails = await fetchFromTMDB(`tv/${currentTvShow.id}`);
                currentTvShow.totalSeasons = tvDetails.number_of_seasons;
                let validSeasons = tvDetails.seasons.filter(s => s.season_number > 0 && s.episode_count > 0);
                 if (validSeasons.length === 0 && tvDetails.seasons.length > 0) {
                    validSeasons = tvDetails.seasons.filter(s => s.episode_count > 0); 
                }

                populateDropdown(modalSeasonSelect, validSeasons, 'season_number', 'name', 'S');
                if (validSeasons.find(s => s.season_number === currentTvShow.season)) {
                    modalSeasonSelect.value = currentTvShow.season;
                } else if (validSeasons.length > 0) {
                    currentTvShow.season = validSeasons[0].season_number; 
                    modalSeasonSelect.value = currentTvShow.season;
                }
                modalSeasonSelect.disabled = false;
                
                await fetchEpisodesForModalSeason(currentTvShow.id, currentTvShow.season);
            } catch (error) {
                modalSeasonSelect.innerHTML = '<option>Error</option>';
                modalEpisodeSelect.innerHTML = '<option>Error</option>';
            }
        }
        
        async function fetchEpisodesForModalSeason(tvId, seasonNumber) {
            modalEpisodeSelect.disabled = true;
            modalEpisodeSelect.innerHTML = '<option>Loading...</option>';
            nextEpisodeButton.disabled = true;
            const cacheKey = `${tvId}-${seasonNumber}`;

            try {
                let seasonDetails;
                if (seasonDetailsCache[cacheKey]) {
                    seasonDetails = seasonDetailsCache[cacheKey];
                } else {
                    seasonDetails = await fetchFromTMDB(`tv/${tvId}/season/${seasonNumber}`);
                    seasonDetailsCache[cacheKey] = seasonDetails; 
                }
                
                currentTvShow.episodesInCurrentSeason = seasonDetails.episodes || [];
                populateDropdown(modalEpisodeSelect, currentTvShow.episodesInCurrentSeason, 'episode_number', 'name', 'E');
                
                if (currentTvShow.episodesInCurrentSeason.find(ep => ep.episode_number === currentTvShow.episode)) {
                    modalEpisodeSelect.value = currentTvShow.episode;
                } else if (currentTvShow.episodesInCurrentSeason.length > 0) {
                    currentTvShow.episode = currentTvShow.episodesInCurrentSeason[0].episode_number; 
                    modalEpisodeSelect.value = currentTvShow.episode;
                }
                
                modalEpisodeSelect.disabled = false;
                updateNextEpisodeButtonState();

            } catch (error) {
                modalEpisodeSelect.innerHTML = '<option>Error</option>';
            }
        }

        function populateDropdown(selectEl, items, valueKey, textKey, prefix = '') {
            selectEl.innerHTML = '';
            if (!items || items.length === 0) {
                selectEl.innerHTML = `<option value="">N/A</option>`;
                return;
            }
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = `${prefix}${item[valueKey]}${item[textKey] && item[textKey] !== `Episode ${item[valueKey]}` ? `: ${item[textKey]}` : ''}`;
                selectEl.appendChild(option);
            });
        }

        function updateNextEpisodeButtonState() {
            if (!currentTvShow.id || currentTvShow.episodesInCurrentSeason.length === 0) {
                nextEpisodeButton.disabled = true;
                return;
            }
            const currentEpisodeIndex = currentTvShow.episodesInCurrentSeason.findIndex(ep => ep.episode_number === currentTvShow.episode);
            const isLastEpisodeInSeason = currentEpisodeIndex === currentTvShow.episodesInCurrentSeason.length - 1;
            const isLastSeason = currentTvShow.season === currentTvShow.totalSeasons;

            if (isLastEpisodeInSeason && isLastSeason) {
                nextEpisodeButton.disabled = true;
            } else {
                nextEpisodeButton.disabled = false;
            }
        }
        
        function playMovie(id, title) {
            modalTvControls.classList.add('hidden');
            const embedURL = `${ANYEMBED_BASE_URL}/movie/${id}?server=${DEFAULT_SERVER}`;
            playerModalTitle.textContent = title || 'Movie';
            loadPlayer(embedURL);
        }

        function playTvShow() {
            if (!currentTvShow.id) return;
            modalTvControls.classList.remove('hidden'); 
            const embedURL = `${ANYEMBED_BASE_URL}/tv/${currentTvShow.id}/${currentTvShow.season}/${currentTvShow.episode}?server=${DEFAULT_SERVER}`;
            playerModalTitle.textContent = `${currentTvShow.name || 'TV Show'} (S${currentTvShow.season} E${currentTvShow.episode})`;
            loadPlayer(embedURL);
            updateNextEpisodeButtonState(); 
        }

        function loadPlayer(url) {
            const sandboxPermissions = [
                "allow-scripts",
                "allow-same-origin",
                "allow-forms", // Often needed by embed players for internal functionality
                "allow-presentation", // For features like Picture-in-Picture
                "allow-fullscreen" // Essential for user experience
                // We are intentionally OMITTING:
                // "allow-popups", 
                // "allow-popups-to-escape-sandbox",
                // "allow-top-navigation",
                // "allow-top-navigation-by-user-activation",
                // "allow-modals" // Could be too restrictive, but an option if popups are aggressive
            ].join(" ");

            playerContainer.innerHTML = `<iframe src="${url}" sandbox="${sandboxPermissions}" allowfullscreen></iframe>`;
            playerModal.style.display = "block";
            document.body.style.overflow = 'hidden';
        }

        function closePlayerModal() {
            playerModal.style.display = "none";
            playerContainer.innerHTML = ""; 
            document.body.style.overflow = 'auto';
            modalTvControls.classList.add('hidden'); 
        }

        searchButton.addEventListener('click', () => {
            const query = searchInput.value.trim();
            if (query) searchTMDB(query);
        });
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = searchInput.value.trim();
                if (query) searchTMDB(query);
            }
        });

        modalSeasonSelect.addEventListener('change', async () => {
            currentTvShow.season = parseInt(modalSeasonSelect.value);
            currentTvShow.episode = 1; 
            await fetchEpisodesForModalSeason(currentTvShow.id, currentTvShow.season);
            playTvShow();
        });


        modalEpisodeSelect.addEventListener('change', () => {
            currentTvShow.episode = parseInt(modalEpisodeSelect.value);
            playTvShow();
        });

        nextEpisodeButton.addEventListener('click', async () => {
            if (!currentTvShow.id || nextEpisodeButton.disabled) return;

            const currentEpisodeIndex = currentTvShow.episodesInCurrentSeason.findIndex(ep => ep.episode_number === currentTvShow.episode);
            
            if (currentEpisodeIndex < currentTvShow.episodesInCurrentSeason.length - 1) {
                currentTvShow.episode = currentTvShow.episodesInCurrentSeason[currentEpisodeIndex + 1].episode_number;
                modalEpisodeSelect.value = currentTvShow.episode; 
                playTvShow();
            } else if (currentTvShow.season < currentTvShow.totalSeasons) {
                currentTvShow.season++;
                currentTvShow.episode = 1; 
                modalSeasonSelect.value = currentTvShow.season; 
            }
        });

        closeModalButton.addEventListener('click', closePlayerModal);
        window.addEventListener('click', (event) => { if (event.target === playerModal) closePlayerModal(); });
        window.addEventListener('keydown', (event) => { if (event.key === 'Escape' && playerModal.style.display === 'block') closePlayerModal(); });

        function reinitializeScrollableContent() {
            moviesScrollWrapper = document.getElementById('moviesScrollWrapper');
            tvScrollWrapper = document.getElementById('tvScrollWrapper');
            document.querySelectorAll('.scroll-button').forEach(button => {
                button.removeEventListener('click', handleScrollButtonClick); 
                button.addEventListener('click', handleScrollButtonClick);
            });
             if(moviesScrollWrapper) {
                moviesScrollWrapper.removeEventListener('scroll', updateMoviesScrollButtons);
                moviesScrollWrapper.addEventListener('scroll', updateMoviesScrollButtons, { passive: true });
                updateScrollButtons(moviesScrollWrapper);
             }
             if(tvScrollWrapper) {
                tvScrollWrapper.removeEventListener('scroll', updateTvScrollButtons);
                tvScrollWrapper.addEventListener('scroll', updateTvScrollButtons, { passive: true });
                updateScrollButtons(tvScrollWrapper); 
             }
        }
        function updateMoviesScrollButtons() { updateScrollButtons(moviesScrollWrapper); }
        function updateTvScrollButtons() { updateScrollButtons(tvScrollWrapper); }
        
        homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            searchInput.value = '';
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div id="statusMessage" class="text-center my-4 h-6"></div>
                <section id="discoverSection">
                    <h2 class="text-3xl font-bold mb-6 border-l-4 border-red-600 pl-3">Most Popular</h2>
                    <div id="discoverGridMovies" class="mb-10">
                        <h3 class="text-2xl font-semibold mb-4">Movies</h3>
                        <div class="horizontal-scroll-container">
                            <button class="scroll-button prev" data-target="moviesScrollWrapper"><i class="fas fa-chevron-left"></i></button>
                            <div id="moviesScrollWrapper" class="scroll-wrapper flex space-x-4"></div>
                            <button class="scroll-button next" data-target="moviesScrollWrapper"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div id="discoverGridTV">
                        <h3 class="text-2xl font-semibold mb-4">TV Shows</h3>
                        <div class="horizontal-scroll-container">
                            <button class="scroll-button prev" data-target="tvScrollWrapper"><i class="fas fa-chevron-left"></i></button>
                            <div id="tvScrollWrapper" class="scroll-wrapper flex space-x-4"></div>
                            <button class="scroll-button next" data-target="tvScrollWrapper"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </section>`;
            window.discoverSection = document.getElementById('discoverSection'); 
            reinitializeScrollableContent();
            loadPopularContent();
        });
        
        mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
        navDiscoverMobile.addEventListener('click', (e) => {
            e.preventDefault();
            mobileMenu.classList.add('hidden');
            homeLink.click();
        });

        function handleScrollButtonClick(event) {
            const button = event.currentTarget;
            const targetId = button.dataset.target;
            const scrollWrapper = document.getElementById(targetId);
            if (!scrollWrapper) return;

            const scrollAmount = scrollWrapper.clientWidth * 0.8; 
            if (button.classList.contains('next')) {
                scrollWrapper.scrollLeft += scrollAmount;
            } else if (button.classList.contains('prev')) {
                scrollWrapper.scrollLeft -= scrollAmount;
            }
        }
         function updateScrollButtons(scrollWrapper) {
            if (!scrollWrapper || !scrollWrapper.parentElement) return;
            const prevButton = scrollWrapper.parentElement.querySelector('.scroll-button.prev');
            const nextButton = scrollWrapper.parentElement.querySelector('.scroll-button.next');
            if(!prevButton || !nextButton) return;

            const isScrollable = scrollWrapper.scrollWidth > scrollWrapper.clientWidth;
            if (!isScrollable) {
                prevButton.style.display = 'none';
                nextButton.style.display = 'none';
                return;
            }
            prevButton.style.display = 'block';
            nextButton.style.display = 'block';

            prevButton.disabled = scrollWrapper.scrollLeft <= 0;
            nextButton.disabled = scrollWrapper.scrollLeft + scrollWrapper.clientWidth >= scrollWrapper.scrollWidth - 5; 
        }

        document.getElementById('currentYear').textContent = new Date().getFullYear();
        reinitializeScrollableContent(); 
        loadPopularContent();

    </script>
</body>
</html>
