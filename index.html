<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyeMovie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #141414; /* Netflix dark background */
        }
        /* Custom scrollbar for modal content (WebKit browsers) */
        #detail-modal-content::-webkit-scrollbar {
            width: 8px;
        }
        #detail-modal-content::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 10px;
        }
        #detail-modal-content::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }
        #detail-modal-content::-webkit-scrollbar-thumb:hover {
            background: #E50914; /* Netflix Red */
        }
        /* For Firefox */
        #detail-modal-content {
            scrollbar-width: thin;
            scrollbar-color: #555 #2d2d2d;
        }

        .nav-link.active {
            color: #E50914; /* Netflix Red */
            font-weight: 600;
        }
        .card-aspect {
            aspect-ratio: 2 / 3;
        }
        .modal-iframe-aspect {
            aspect-ratio: 16 / 9;
        }
        /* Basic styling for custom message box */
        #message-box {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .message-box-enter {
            opacity: 0;
            transform: translateY(-20px) translateX(-50%);
        }
        .message-box-leave {
            opacity: 0;
            transform: translateY(-20px) translateX(-50%);
        }
        .message-box-active {
            opacity: 1;
            transform: translateY(0) translateX(-50%);
        }
    </style>
</head>
<body class="text-white">

    <header class="bg-black bg-opacity-80 backdrop-blur-md p-4 fixed top-0 left-0 right-0 z-40 shadow-lg">
        <div class="container mx-auto flex flex-wrap justify-between items-center">
            <h1 id="logo" class="text-3xl font-black text-red-600 cursor-pointer order-1 sm:order-1">SkyeMovie</h1>
            <nav class="space-x-2 sm:space-x-4 order-3 sm:order-2 w-full sm:w-auto mt-2 sm:mt-0 flex justify-center sm:justify-start">
                <button data-page="movies" class="nav-link text-white hover:text-red-500 px-2 py-1 sm:px-3 sm:py-2 rounded-md text-sm font-medium">Movies</button>
                <button data-page="tv" class="nav-link text-white hover:text-red-500 px-2 py-1 sm:px-3 sm:py-2 rounded-md text-sm font-medium">TV Shows</button>
            </nav>
            <div class="w-full sm:w-1/3 min-w-[180px] order-2 sm:order-3 mt-2 sm:mt-0">
                <input type="search" id="search-input" placeholder="Search titles (min 3 chars)..." class="bg-neutral-700 text-white placeholder-gray-400 w-full px-4 py-2 rounded-full focus:ring-2 focus:ring-red-500 focus:outline-none text-sm">
            </div>
        </div>
    </header>

    <main id="app-content" class="pt-36 sm:pt-28 p-4 md:p-8">
        <div id="loading-spinner" class="text-center py-10 hidden">
            <svg class="animate-spin h-12 w-12 text-red-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-white mt-3 text-lg">Loading...</p>
        </div>

        <section id="movies-discover-view" class="hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-white mb-6">Discover Movies</h2>
            <div id="movies-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6">
                </div>
            <div id="movies-pagination" class="mt-8 text-center space-x-2"></div>
        </section>

        <section id="tv-shows-discover-view" class="hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-white mb-6">Discover TV Shows</h2>
            <div id="tv-shows-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6">
                </div>
            <div id="tv-shows-pagination" class="mt-8 text-center space-x-2"></div>
        </section>

        <section id="search-results-view" class="hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-white mb-6">Search Results for "<span id="search-query-display" class="text-red-500"></span>"</h2>
            <div>
                <h3 class="text-xl sm:text-2xl font-semibold text-white my-4 border-b border-neutral-700 pb-2">Movies</h3>
                <div id="search-movies-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6"></div>
                <p id="search-movies-no-results" class="text-gray-400 hidden mt-4">No movies found matching your query.</p>
            </div>
            <div class="mt-8">
                <h3 class="text-xl sm:text-2xl font-semibold text-white my-4 border-b border-neutral-700 pb-2">TV Shows</h3>
                <div id="search-tv-shows-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6"></div>
                <p id="search-tv-shows-no-results" class="text-gray-400 hidden mt-4">No TV shows found matching your query.</p>
            </div>
        </section>
    </main>

    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 p-4">
        <div class="bg-neutral-800 rounded-lg shadow-xl w-full max-w-xs sm:max-w-md md:max-w-2xl lg:max-w-4xl max-h-[95vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-neutral-700">
                <h3 id="detail-modal-title" class="text-xl font-semibold text-white">Details</h3>
                <button id="close-modal-button" class="text-gray-300 hover:text-red-500 text-3xl leading-none">&times;</button>
            </div>
            <div id="detail-modal-content" class="p-2 sm:p-4 overflow-y-auto flex-grow">
                </div>
        </div>
    </div>

    <div id="message-box" class="fixed top-24 left-1/2 bg-red-600 text-white p-3 px-5 rounded-md shadow-lg z-[100] message-box-enter">
        <span id="message-box-text"></span>
    </div>


    <script>
        // API Configuration
        const BASE_DISCOVER_API_URL = "https://moviesapi.to/api";
        const BASE_CONTENT_URL = "https://moviesapi.club"; // Assuming HTTPS works, or change to HTTP if necessary
        const RESULTS_PER_PAGE = 18; // Adjusted for better grid layout

        // DOM Elements
        const logo = document.getElementById('logo');
        const navLinks = document.querySelectorAll('.nav-link');
        const searchInput = document.getElementById('search-input');
        const appContent = document.getElementById('app-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        const moviesDiscoverView = document.getElementById('movies-discover-view');
        const moviesGrid = document.getElementById('movies-grid');
        const moviesPaginationContainer = document.getElementById('movies-pagination');

        const tvShowsDiscoverView = document.getElementById('tv-shows-discover-view');
        const tvShowsGrid = document.getElementById('tv-shows-grid');
        const tvShowsPaginationContainer = document.getElementById('tv-shows-pagination');

        const searchResultsView = document.getElementById('search-results-view');
        const searchQueryDisplay = document.getElementById('search-query-display');
        const searchMoviesGrid = document.getElementById('search-movies-grid');
        const searchMoviesNoResults = document.getElementById('search-movies-no-results');
        const searchTvShowsGrid = document.getElementById('search-tv-shows-grid');
        const searchTvShowsNoResults = document.getElementById('search-tv-shows-no-results');

        const detailModal = document.getElementById('detail-modal');
        const detailModalTitle = document.getElementById('detail-modal-title');
        const detailModalContent = document.getElementById('detail-modal-content');
        const closeModalButton = document.getElementById('close-modal-button');

        const messageBox = document.getElementById('message-box');
        const messageBoxText = document.getElementById('message-box-text');

        // State
        let currentView = 'movies';
        let currentPageMovies = 1;
        let totalPagesMovies = 1;
        let currentPageTvShows = 1;
        let totalPagesTvShows = 1;
        let currentSearchTerm = '';

        // --- UTILITY FUNCTIONS ---
        function showLoading() { loadingSpinner.classList.remove('hidden'); }
        function hideLoading() { loadingSpinner.classList.add('hidden'); }

        function showView(viewElement) {
            [moviesDiscoverView, tvShowsDiscoverView, searchResultsView].forEach(v => v.classList.add('hidden'));
            if (viewElement) viewElement.classList.remove('hidden');
        }

        function getPlaceholderUrl(width, height, text = "No Image") {
            return `https://placehold.co/${width}x${height}/1F1F1F/777777?text=${encodeURIComponent(text)}&font=Inter`;
        }

        function showMessage(message, duration = 3000) {
            messageBoxText.textContent = message;
            messageBox.classList.remove('message-box-enter', 'message-box-leave', 'hidden');
            messageBox.classList.add('message-box-active');
            setTimeout(() => {
                messageBox.classList.remove('message-box-active');
                messageBox.classList.add('message-box-leave');
                setTimeout(() => messageBox.classList.add('hidden'), 300); // Wait for animation
            }, duration);
        }
        
        async function fetchApi(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.error("API Error:", response.status, await response.text());
                    showMessage(`Error: ${response.status}. Could not fetch data.`);
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error("Fetch Error:", error);
                showMessage("Network error or API unavailable.");
                return null;
            }
        }

        // --- RENDERING FUNCTIONS ---
        function createItemCard(item, type) {
            const card = document.createElement('div');
            card.className = 'bg-neutral-800 rounded-lg shadow-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-transform duration-200 ease-in-out flex flex-col';
            
            const posterUrl = item.poster && item.poster !== "N/A" ? item.poster : getPlaceholderUrl(300, 450, item.title);
            
            // Sanitize title to prevent XSS if it were ever used in a vulnerable way (good practice)
            const safeTitle = item.title ? String(item.title).replace(/</g, "&lt;").replace(/>/g, "&gt;") : "Untitled";
            const year = item.year || 'N/A';

            card.innerHTML = `
                <div class="w-full card-aspect bg-neutral-700">
                    <img src="${posterUrl}" alt="${safeTitle}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='${getPlaceholderUrl(300,450,safeTitle)}';">
                </div>
                <div class="p-3 flex flex-col flex-grow">
                    <h3 class="text-sm sm:text-md font-semibold text-white truncate" title="${safeTitle}">${safeTitle}</h3>
                    <p class="text-xs text-gray-400 mt-1">${year}</p>
                </div>
            `;
            card.addEventListener('click', () => openDetailModal(item.id, type, safeTitle, posterUrl, item));
            return card;
        }

        function renderItems(items, gridElement, itemType, noResultsElement = null) {
            gridElement.innerHTML = ''; // Clear previous items
            if (noResultsElement) noResultsElement.classList.add('hidden');

            if (items && items.length > 0) {
                items.forEach(item => {
                    // The API might have different structures for id (e.g. imdb_id or id)
                    // We need to ensure 'item.id' is correctly sourced.
                    // Assuming discover API returns 'id' as the primary identifier.
                    // If it's nested (e.g. item.ids.tmdb), adjust accordingly.
                    // For now, let's assume 'id' is directly available.
                    if (!item.id && item.imdb_id) item.id = item.imdb_id; // Fallback if 'id' is missing but 'imdb_id' exists

                    if (item.id) { // Only render if we have an ID
                        gridElement.appendChild(createItemCard(item, itemType));
                    } else {
                        console.warn("Item skipped due to missing ID:", item);
                    }
                });
            } else {
                if (noResultsElement) {
                    noResultsElement.classList.remove('hidden');
                } else {
                    gridElement.innerHTML = `<p class="col-span-full text-center text-gray-400 py-8">No ${itemType}s found.</p>`;
                }
            }
        }
        
        function renderPagination(container, currentPage, totalPages, pageChangeHandler) {
            container.innerHTML = '';
            if (totalPages <= 1) return;

            const createButton = (text, page, enabled = true) => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = `bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-sm ${!enabled ? 'opacity-50 cursor-not-allowed' : ''}`;
                if (enabled) {
                    button.addEventListener('click', () => pageChangeHandler(page));
                } else {
                    button.disabled = true;
                }
                return button;
            };

            container.appendChild(createButton('Previous', currentPage - 1, currentPage > 1));
            
            const pageIndicator = document.createElement('span');
            pageIndicator.className = "text-white mx-2 sm:mx-4";
            pageIndicator.textContent = `Page ${currentPage} of ${totalPages}`;
            container.appendChild(pageIndicator);

            container.appendChild(createButton('Next', currentPage + 1, currentPage < totalPages));
        }

        // --- DATA FETCHING AND DISPLAY ---
        async function fetchAndDisplayMovies(page = 1) {
            showLoading();
            currentPageMovies = page;
            const data = await fetchApi(`${BASE_DISCOVER_API_URL}/discover/movie?page=${page}&resultsPerPage=${RESULTS_PER_PAGE}&ordering=year&direction=desc`);
            hideLoading();
            if (data && data.results) {
                renderItems(data.results, moviesGrid, 'movie');
                // Assuming API provides total results or total pages. If not, this needs adjustment.
                // For now, let's estimate total pages if API provides 'totalResults'.
                totalPagesMovies = data.totalResults ? Math.ceil(data.totalResults / RESULTS_PER_PAGE) : (data.results.length > 0 ? currentPageMovies +1 : currentPageMovies); // Simple estimation
                if (data.total_pages) totalPagesMovies = data.total_pages; // If API provides total_pages
                renderPagination(moviesPaginationContainer, currentPageMovies, totalPagesMovies, fetchAndDisplayMovies);
            } else {
                 moviesGrid.innerHTML = `<p class="col-span-full text-center text-gray-400 py-8">Could not load movies. Please try again later.</p>`;
                 totalPagesMovies = 1; // Reset pagination if fetch fails
                 renderPagination(moviesPaginationContainer, currentPageMovies, totalPagesMovies, fetchAndDisplayMovies);
            }
        }

        async function fetchAndDisplayTvShows(page = 1) {
            showLoading();
            currentPageTvShows = page;
            const data = await fetchApi(`${BASE_DISCOVER_API_URL}/discover/tv?page=${page}&resultsPerPage=${RESULTS_PER_PAGE}&ordering=year&direction=desc`);
            hideLoading();
            if (data && data.results) {
                renderItems(data.results, tvShowsGrid, 'tv');
                totalPagesTvShows = data.totalResults ? Math.ceil(data.totalResults / RESULTS_PER_PAGE) : (data.results.length > 0 ? currentPageTvShows + 1 : currentPageTvShows);
                if (data.total_pages) totalPagesTvShows = data.total_pages;
                renderPagination(tvShowsPaginationContainer, currentPageTvShows, totalPagesTvShows, fetchAndDisplayTvShows);
            } else {
                tvShowsGrid.innerHTML = `<p class="col-span-full text-center text-gray-400 py-8">Could not load TV shows. Please try again later.</p>`;
                totalPagesTvShows = 1;
                renderPagination(tvShowsPaginationContainer, currentPageTvShows, totalPagesTvShows, fetchAndDisplayTvShows);
            }
        }

        async function performSearch(query) {
            if (query.length < 3) {
                showMessage("Search query must be at least 3 characters long.");
                return;
            }
            currentSearchTerm = query;
            showLoading();
            searchQueryDisplay.textContent = query;
            showView(searchResultsView);

            // Fetch movies
            const movieData = await fetchApi(`${BASE_DISCOVER_API_URL}/discover/movie?query=${encodeURIComponent(query)}&resultsPerPage=${RESULTS_PER_PAGE}&direction=desc&page=1`);
            if (movieData && movieData.results) {
                renderItems(movieData.results, searchMoviesGrid, 'movie', searchMoviesNoResults);
            } else {
                searchMoviesGrid.innerHTML = '';
                searchMoviesNoResults.classList.remove('hidden');
            }

            // Fetch TV shows
            const tvData = await fetchApi(`${BASE_DISCOVER_API_URL}/discover/tv?query=${encodeURIComponent(query)}&resultsPerPage=${RESULTS_PER_PAGE}&direction=desc&page=1`);
            if (tvData && tvData.results) {
                renderItems(tvData.results, searchTvShowsGrid, 'tv', searchTvShowsNoResults);
            } else {
                searchTvShowsGrid.innerHTML = '';
                searchTvShowsNoResults.classList.remove('hidden');
            }
            hideLoading();
        }

        // --- MODAL LOGIC ---
        function openDetailModal(id, type, title, posterUrl, itemData) { // itemData passed for TV show posters
            detailModalTitle.textContent = title;
            detailModalContent.innerHTML = ''; // Clear previous content

            if (type === 'movie') {
                const iframeSrc = `${BASE_CONTENT_URL}/movie/${id}`;
                detailModalContent.innerHTML = `
                    <div class="w-full h-full modal-iframe-aspect">
                        <iframe src="${iframeSrc}" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 p-2">Attempting to load content for "${title}". If it doesn't load, the provider may not allow embedding or the content might be unavailable.</p>
                `;
            } else if (type === 'tv') {
                // Use poster from itemData if available, otherwise the one passed (which might be a placeholder)
                const actualPosterUrl = (itemData && itemData.poster && itemData.poster !== "N/A") ? itemData.poster : posterUrl;
                
                detailModalContent.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-4 items-start">
                        <div class="w-full md:w-1/3 flex-shrink-0">
                             <img src="${actualPosterUrl}" alt="${title}" class="w-full h-auto object-cover rounded-md shadow-md" onerror="this.onerror=null;this.src='${getPlaceholderUrl(200,300,title)}';">
                        </div>
                        <div class="w-full md:w-2/3">
                            <p class="text-gray-300 mb-3 text-sm">Enter season and episode number for "${title}" to watch.</p>
                            <div class="mb-3">
                                <label for="season-input" class="block text-sm font-medium text-gray-300">Season:</label>
                                <input type="number" id="season-input" value="1" min="1" class="mt-1 block w-full bg-neutral-700 border-neutral-600 text-white rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm p-2">
                            </div>
                            <div class="mb-4">
                                <label for="episode-input" class="block text-sm font-medium text-gray-300">Episode:</label>
                                <input type="number" id="episode-input" value="1" min="1" class="mt-1 block w-full bg-neutral-700 border-neutral-600 text-white rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm p-2">
                            </div>
                            <button id="watch-tv-episode-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors">Load Episode</button>
                        </div>
                    </div>
                    <div id="tv-episode-iframe-container" class="mt-4 w-full h-0 modal-iframe-aspect transition-all duration-300 ease-in-out overflow-hidden"></div>
                     <p id="tv-embed-info" class="text-xs text-gray-400 mt-2 p-2 hidden">Attempting to load episode. If it doesn't load, the provider may not allow embedding or the content might be unavailable.</p>
                `;

                const watchButton = document.getElementById('watch-tv-episode-button');
                const seasonInput = document.getElementById('season-input');
                const episodeInput = document.getElementById('episode-input');
                const iframeContainer = document.getElementById('tv-episode-iframe-container');
                const tvEmbedInfo = document.getElementById('tv-embed-info');

                watchButton.addEventListener('click', () => {
                    const season = seasonInput.value;
                    const episode = episodeInput.value;
                    if (season && episode) {
                        const iframeSrc = `${BASE_CONTENT_URL}/tv/${id}-${season}-${episode}`;
                        iframeContainer.innerHTML = `<iframe src="${iframeSrc}" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                        iframeContainer.style.height = ''; // Reset to allow aspect ratio to control it
                        tvEmbedInfo.classList.remove('hidden');
                    } else {
                        showMessage("Please enter valid season and episode numbers.");
                    }
                });
            }
            detailModal.classList.remove('hidden');
            detailModal.classList.add('flex'); // Use flex for centering
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeModal() {
            detailModal.classList.add('hidden');
            detailModal.classList.remove('flex');
            detailModalContent.innerHTML = ''; // Clear content to stop any playing media
            document.body.style.overflow = 'auto';
        }

        // --- NAVIGATION ---
        function navigateTo(pageName) {
            currentView = pageName;
            showLoading();
            
            // Update active link style
            navLinks.forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageName);
            });

            if (pageName === 'movies') {
                showView(moviesDiscoverView);
                fetchAndDisplayMovies(currentPageMovies); // Or 1 if you want to reset
            } else if (pageName === 'tv') {
                showView(tvShowsDiscoverView);
                fetchAndDisplayTvShows(currentPageTvShows); // Or 1
            } else if (pageName === 'search') {
                // Search is handled by performSearch, which calls showView(searchResultsView)
                // This case is for if navigateTo is called directly with 'search'
                if (currentSearchTerm) {
                    performSearch(currentSearchTerm);
                } else {
                    // If no search term, maybe default to movies or show a message
                    navigateTo('movies'); 
                }
            }
            hideLoading(); // Should be hidden by specific fetch functions, but as a fallback
            window.scrollTo(0, 0); // Scroll to top on navigation
        }

        // --- EVENT LISTENERS ---
        logo.addEventListener('click', () => {
            searchInput.value = ''; // Clear search on logo click
            currentPageMovies = 1; // Reset to first page
            navigateTo('movies');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                searchInput.value = ''; // Clear search on nav click
                if (link.dataset.page === 'movies') currentPageMovies = 1;
                if (link.dataset.page === 'tv') currentPageTvShows = 1;
                navigateTo(link.dataset.page);
            });
        });

        searchInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    performSearch(searchTerm);
                } else {
                     // If search is cleared and enter pressed, go to default view
                    navigateTo('movies');
                }
            }
        });
        // Also handle search if user clears input and presses enter
        searchInput.addEventListener('search', function() { // For the 'x' button in some browsers
            if (!searchInput.value.trim()) {
                navigateTo('movies'); // Or last active view
            }
        });


        closeModalButton.addEventListener('click', closeModal);
        detailModal.addEventListener('click', function(event) {
            // Close modal if backdrop is clicked
            if (event.target === detailModal) {
                closeModal();
            }
        });
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && !detailModal.classList.contains('hidden')) {
                closeModal();
            }
        });


        // --- INITIALIZATION ---
        function init() {
            // Hide message box initially
            messageBox.classList.add('hidden');
            messageBox.classList.add('message-box-enter');

            navigateTo('movies'); // Default view
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
