<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyeMovie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Inline&display=swap" rel="stylesheet">
    <style>
        html, body {
            overscroll-behavior-y: contain; 
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #141414;
            color: #e5e5e5;
        }
        .title-font {
            font-family: 'Bungee Inline', cursive;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #232323; }
        ::-webkit-scrollbar-thumb { background: #e50914; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f40612; }

        .netflix-red-text { color: #e50914; }
        .input-field, .select-field {
            background-color: #333; border: 1px solid #555; color: #fff;
            border-radius: 0.25rem; padding: 0.5rem 0.75rem;
            transition: border-color 0.2s ease-in-out; width: 100%;
        }
        .input-field:focus, .select-field:focus { outline: none; border-color: #e50914; }
        
        .card {
            background-color: #1f1f1f; border-radius: 0.5rem;
            overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            width: 180px; 
            flex-shrink: 0; 
            position: relative; 
        }
        .card:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .card img { width: 100%; height: 270px; object-fit: cover; }
        .card .favorite-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: rgba(0,0,0,0.6);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
            z-index: 5; 
        }
        .card .favorite-icon:hover { transform: scale(1.1); }
        .card .favorite-icon.is-favorite { color: #e50914; }
        
        .iframe-container { 
            position: relative; overflow: hidden; width: 100%; 
            padding-top: 56.25%; background-color: #000; flex-grow: 1; 
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            cursor: pointer;
        }
        .iframe-container iframe { 
            position: absolute; top: 0; left: 0; bottom: 0; right: 0; 
            width: 100%; height: 100%; 
            border: none; 
            pointer-events: auto; 
            display: block;
        }
        
        .modal { display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); }
        #infoModal { z-index: 1000; }
        #playerModal { z-index: 1010; } 

        .modal-content { 
            background-color: #181818; border-radius: 8px;
            width: 95vw; max-width: 900px; 
            max-height: 95vh; display: flex; flex-direction: column;
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            overflow-y: auto; padding: 15px; 
            -webkit-overflow-scrolling: touch; 
        }
        .close-button { 
            color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;
            position: absolute; top: 8px; right: 10px; z-index: 1020; 
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
        }
        .close-button:hover, .close-button:focus { color: #e50914; text-decoration: none; }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            border-top: 4px solid #e50914; width: 24px; height: 24px;
            animation: spin 1s linear infinite;
            margin: 20px auto; /* Added margin for better visibility */
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .horizontal-scroll-container { position: relative; }
        .scroll-wrapper {
            display: flex; overflow-x: auto; scroll-behavior: smooth; padding-bottom: 1rem; 
            -ms-overflow-style: none; scrollbar-width: none;  
            min-height: 300px; /* Ensure space for cards or spinner */
        }
        .scroll-wrapper::-webkit-scrollbar { display: none; }
        .scroll-button {
            position: absolute; top: 50%; transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.6); color: white; border: none;
            padding: 0.8rem 0.5rem; cursor: pointer; z-index: 10;
            border-radius: 0.25rem; font-size: 1.5rem; line-height: 1;
            opacity: 0.7; transition: opacity 0.2s;
        }
        .scroll-button:hover { opacity: 1; }
        .scroll-button.prev { left: 5px; }
        .scroll-button.next { right: 5px; }
        .scroll-button:disabled { opacity:0.3; cursor: not-allowed;}

        #modalTvControls, #infoModalTvControls { background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; margin-top: 10px; }
        .btn-action, .btn-next-episode, .btn-show-more { 
            background-color: #e50914; color: white; font-weight: bold;
            padding: 0.6rem 1.2rem; border-radius: 0.25rem;
            transition: background-color 0.2s ease-in-out; cursor: pointer; border: none;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-action:hover, .btn-next-episode:hover, .btn-show-more:hover { background-color: #f40612; }
        .btn-action:disabled, .btn-next-episode:disabled, .btn-show-more:disabled { background-color: #555; cursor: not-allowed; }
        .btn-show-more { background-color: #333; margin-top: 0.5rem; }
        .btn-show-more:hover { background-color: #444; }
        
        #searchResultsGrid, #favoritesGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; }
        #searchResultsGrid .card, #favoritesGrid .card { width: 100%; }

        .filter-btn {
            padding: 0.4rem 0.8rem; border-radius: 0.25rem; border: 1px solid #555;
            background-color: #333; color: #ccc; cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            font-size: 0.875rem;
        }
        .filter-btn:hover { background-color: #444; }
        .filter-btn.active { background-color: #e50914; color: white; border-color: #e50914; }
        .nav-link {
            cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.25rem;
            transition: background-color 0.2s ease-in-out;
            color: #e5e5e5;
        }
        .nav-link:hover, .nav-link.active { background-color: rgba(229, 9, 20, 0.2); }

        #infoModalContent .info-poster { width: 120px; height: 180px; object-fit: cover; border-radius: 0.25rem; flex-shrink: 0;}
        @media (min-width: 640px) { 
            #infoModalContent .info-poster { width: 150px; height: 225px; }
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 98vw; height: auto; max-height: 98vh; 
                padding: 10px; 
            }
             #playerModalTitle, #infoModalTitle {
                font-size: 1rem; margin-bottom: 8px; padding-right: 35px; 
            }
            #modalTvControls, #infoModalTvControls { padding: 8px; margin-top: 10px; }
            #modalTvControls .select-field, #modalTvControls .btn-next-episode,
            #infoModalTvControls .select-field {
                font-size: 0.8rem; padding: 0.4rem 0.6rem;
            }
            #modalTvControls label, #infoModalTvControls label { font-size: 0.8rem; }
            .modal-content > p.text-xs { font-size: 0.7rem; margin-top: 8px; }
            .btn-action { padding: 0.5rem 1rem; font-size: 0.9rem; }
        }
        .donation-banner {
            background-color: #e50914; 
            color: white;
            padding: 0.75rem 1rem;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            display: block; 
            transition: background-color 0.2s ease-in-out;
            text-decoration: none; 
        }
        .donation-banner:hover {
            background-color: #f40612; 
        }
    </style>
</head>
<body class="text-gray-200">

    <header class="bg-black bg-opacity-90 shadow-lg sticky top-0 z-50 backdrop-blur-md">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <a href="#" id="homeLink" class="text-3xl font-bold netflix-red-text title-font">SkyeMovie</a>
                <nav class="hidden md:flex items-center space-x-2">
                    <a href="#" id="navDiscoverDesktop" class="nav-link active">Discover</a>
                    <a href="#" id="navFavoritesDesktop" class="nav-link">My Favorites</a>
                    <div class="flex-grow items-center max-w-lg ml-4">
                        <div class="relative w-full">
                            <input type="text" id="desktopSearchInput" class="input-field w-full pr-10" placeholder="Search...">
                            <button id="desktopSearchButton" class="absolute inset-y-0 right-0 px-3 text-gray-400 hover:text-e50914">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                     <div id="desktopSearchFilters" class="flex space-x-1 ml-2">
                        <button class="filter-btn active" data-filter="multi">All</button>
                        <button class="filter-btn" data-filter="movie">Movies</button>
                        <button class="filter-btn" data-filter="tv">TV</button>
                    </div>
                </nav>
                <div class="md:hidden">
                    <button id="mobileMenuButton" class="text-gray-300 hover:text-white focus:outline-none">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobileMenu" class="md:hidden hidden bg-black bg-opacity-90 p-4 space-y-3">
            <div class="relative w-full">
                 <input type="text" id="mobileSearchInput" class="input-field w-full pr-10" placeholder="Search...">
                 <button id="mobileSearchButton" class="absolute inset-y-0 right-0 px-3 text-gray-400 hover:text-e50914">
                    <i class="fas fa-search"></i>
                 </button>
            </div>
            <div id="mobileSearchFilters" class="flex justify-center space-x-2">
                <button class="filter-btn active" data-filter="multi">All</button>
                <button class="filter-btn" data-filter="movie">Movies</button>
                <button class="filter-btn" data-filter="tv">TV</button>
            </div>
            <a href="#" id="navDiscoverMobile" class="block text-center py-2 hover:bg-gray-700 rounded-md">Discover</a>
            <a href="#" id="navFavoritesMobile" class="block text-center py-2 hover:bg-gray-700 rounded-md">My Favorites</a>
            <a href="https://skyebeta.vercel.app/" target="_blank" rel="noopener noreferrer" class="block text-center py-2 hover:bg-gray-700 rounded-md">iOS App (Beta)</a>
        </div>
    </header>

    <a href="https://fundly.com/keep-skyemovie-free-for-everyone" id="donationBanner" class="donation-banner" target="_blank" rel="noopener noreferrer">
        ❤️ Donations help keep SkyeMovie free for everyone! Click here to support us. ❤️
    </a>
    
    <main class="container mx-auto p-4 sm:p-6 lg:p-8" id="mainContent">
        <div id="statusMessage" class="text-center my-4 h-6"></div>
        
        <section id="discoverSection" class="mb-12"> 
            <h2 id="contentAreaTitle" class="text-3xl font-bold mb-6 border-l-4 border-red-600 pl-3">Discover</h2>
            
            <div id="tmdbMoviesContainer" class="mb-10 category-container">
                <h3 class="text-2xl font-semibold mb-4">Top Rated Movies</h3>
                <div class="horizontal-scroll-container">
                    <button class="scroll-button prev" data-target="tmdbMoviesScrollWrapper"><i class="fas fa-chevron-left"></i></button>
                    <div id="tmdbMoviesScrollWrapper" class="scroll-wrapper flex space-x-4"></div>
                    <button class="scroll-button next" data-target="tmdbMoviesScrollWrapper"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <div id="tmdbTvShowsContainer" class="mb-10 category-container">
                <h3 class="text-2xl font-semibold mb-4">Top Rated TV Shows</h3>
                 <div class="horizontal-scroll-container">
                    <button class="scroll-button prev" data-target="tmdbTvScrollWrapper"><i class="fas fa-chevron-left"></i></button>
                    <div id="tmdbTvScrollWrapper" class="scroll-wrapper flex space-x-4"></div>
                    <button class="scroll-button next" data-target="tmdbTvScrollWrapper"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </section>

        <section id="watchmodeCategoriesSection" class="mb-12">
            <h2 class="text-3xl font-bold mb-6 border-l-4 border-red-600 pl-3">Browse by Service</h2>
            <div id="watchmodeCategoriesGrid" class="space-y-10">
            </div>
        </section>


        <section id="searchResultsSection" class="hidden mt-8">
             <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
                <h2 id="searchResultsTitle" class="text-2xl font-semibold">Search Results</h2>
                <select id="sortResultsSelect" class="select-field w-full sm:w-auto text-sm py-1.5">
                    <option value="popularity.desc">Sort by Popularity</option>
                    <option value="date.desc">Date (New to Old)</option>
                    <option value="date.asc">Date (Old to New)</option>
                </select>
            </div>
            <div id="searchResultsGrid"></div>
        </section>

        <section id="favoritesSection" class="hidden mt-8">
             <h2 id="favoritesTitle" class="text-3xl font-bold mb-6 border-l-4 border-red-600 pl-3">My Favorites</h2>
            <div id="favoritesGrid"></div>
        </section>
    </main>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-start mb-3">
                <h3 id="infoModalTitle" class="text-xl sm:text-2xl font-semibold"></h3>
                <span class="close-button" id="closeInfoModalButton">&times;</span>
            </div>
            <div id="infoModalContent" class="flex flex-col sm:flex-row gap-4">
                <img id="infoModalPoster" src="" alt="Poster" class="info-poster">
                <div class="flex-grow">
                    <p class="text-sm text-gray-400 mb-1">Rating: <span id="infoModalRating" class="font-semibold text-gray-200"></span></p>
                    <p class="text-sm text-gray-400 mb-1">Released: <span id="infoModalReleaseDate" class="font-semibold text-gray-200"></span></p>
                    <p class="text-sm text-gray-400 mb-2">Genres: <span id="infoModalGenres" class="font-semibold text-gray-200"></span></p>
                    <p id="infoModalOverview" class="text-sm mb-3 max-h-28 overflow-y-auto"></p>
                    
                    <div id="infoModalTvControls" class="hidden space-y-2 mb-3">
                        <div class="flex items-center gap-2">
                            <label for="infoModalSeasonSelect" class="text-sm flex-shrink-0">Season:</label>
                            <select id="infoModalSeasonSelect" class="select-field text-sm"></select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="infoModalEpisodeSelect" class="text-sm flex-shrink-0">Episode:</label>
                            <select id="infoModalEpisodeSelect" class="select-field text-sm"></select>
                        </div>
                    </div>
                     <div class="flex flex-col sm:flex-row gap-3 mt-auto">
                        <button id="infoModalPlayButton" class="btn-action flex-grow"><i class="fas fa-play mr-2"></i>Play</button>
                        <button id="infoModalFavoriteButton" class="btn-action bg-gray-600 hover:bg-gray-500 flex-grow"><i class="far fa-heart mr-2"></i>Add to Favorites</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="playerModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-start mb-2">
                <h3 id="playerModalTitle" class="text-xl font-semibold">Now Playing</h3>
                <span class="close-button" id="closePlayerModalButton">&times;</span>
            </div>
            <div id="playerContainer" class="iframe-container"></div>
            
            <div id="modalTvControls" class="hidden">
                <h4 id="modalTvShowTitle" class="text-md font-semibold mb-2"></h4>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-center">
                    <div class="flex items-center gap-2">
                        <label for="modalSeasonSelect" class="text-sm flex-shrink-0">Season:</label>
                        <select id="modalSeasonSelect" class="select-field text-sm"></select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="modalEpisodeSelect" class="text-sm flex-shrink-0">Episode:</label>
                        <select id="modalEpisodeSelect" class="select-field text-sm"></select>
                    </div>
                    <button id="nextEpisodeButton" class="btn-next-episode text-sm sm:col-start-3">Next Episode <i class="fas fa-step-forward ml-1"></i></button>
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-3">Player provided by SuperEmbed. We strive to keep advertising minimal.</p>
        </div>
    </div>

    <footer class="text-center p-6 mt-4 border-t border-gray-700">
        <p class="text-sm text-gray-400">SkyeMovie is in development. For the latest updates and community chat, join us on Telegram:</p>
        <a href="https://t.me/skyemovieupdates" target="_blank" rel="noopener noreferrer" class="text-lg netflix-red-text hover:underline font-semibold">
            <i class="fab fa-telegram-plane mr-1"></i> SkyeMovie Updates
        </a>
        <p class="text-xs text-gray-500 mt-2">&copy; <span id="currentYear"></span> SkyeMovie.</p>
    </footer>

    <script>
        const TMDB_IMG_BASE_URL = 'https://image.tmdb.org/t/p/w500';
        const SUPEREMBED_PLAYER_PROXY_URL = '/api/superembed-proxy';
        const WATCHMODE_PROXY_URL = '/api/watchmode-proxy';
        const WATCHMODE_ITEMS_PER_PAGE = 20;
        const WATCHMODE_ITEMS_TO_LOAD_ON_SHOW_MORE = 20;

        const WATCHMODE_SOURCES = [
            { id: 203, name: "Netflix" },
            { id: 372, name: "Max" },
            { id: 157, name: "Hulu" },
            { id: 387, name: "Disney+" },
            { id: 26, name: "Amazon Prime Video" }
        ];
        let watchModeCategoryData = {};

        const desktopSearchInput = document.getElementById('desktopSearchInput');
        const desktopSearchButton = document.getElementById('desktopSearchButton');
        const mobileSearchInput = document.getElementById('mobileSearchInput');
        const mobileSearchButton = document.getElementById('mobileSearchButton');
        const desktopSearchFilters = document.getElementById('desktopSearchFilters');
        const mobileSearchFilters = document.getElementById('mobileSearchFilters');
        const statusMessage = document.getElementById('statusMessage');
        
        const infoModal = document.getElementById('infoModal');
        const infoModalTitle = document.getElementById('infoModalTitle');
        const infoModalPoster = document.getElementById('infoModalPoster');
        const infoModalRating = document.getElementById('infoModalRating');
        const infoModalReleaseDate = document.getElementById('infoModalReleaseDate');
        const infoModalGenres = document.getElementById('infoModalGenres');
        const infoModalOverview = document.getElementById('infoModalOverview');
        const infoModalTvControls = document.getElementById('infoModalTvControls');
        const infoModalSeasonSelect = document.getElementById('infoModalSeasonSelect');
        const infoModalEpisodeSelect = document.getElementById('infoModalEpisodeSelect');
        const infoModalPlayButton = document.getElementById('infoModalPlayButton');
        const infoModalFavoriteButton = document.getElementById('infoModalFavoriteButton');
        const closeInfoModalButton = document.getElementById('closeInfoModalButton');
        
        const playerModal = document.getElementById('playerModal');
        const playerContainer = document.getElementById('playerContainer');
        const closePlayerModalButton = document.getElementById('closePlayerModalButton');
        const playerModalTitle = document.getElementById('playerModalTitle');

        const modalTvControls = document.getElementById('modalTvControls');
        const modalTvShowTitleEl = document.getElementById('modalTvShowTitle');
        const modalSeasonSelect = document.getElementById('modalSeasonSelect');
        const modalEpisodeSelect = document.getElementById('modalEpisodeSelect');
        const nextEpisodeButton = document.getElementById('nextEpisodeButton');

        const discoverSection = document.getElementById('discoverSection');
        const contentAreaTitle = document.getElementById('contentAreaTitle');
        const tmdbMoviesContainer = document.getElementById('tmdbMoviesContainer');
        const tmdbTvShowsContainer = document.getElementById('tmdbTvShowsContainer');
        let tmdbMoviesScrollWrapper = document.getElementById('tmdbMoviesScrollWrapper'); 
        let tmdbTvScrollWrapper = document.getElementById('tmdbTvScrollWrapper'); 
        
        const watchmodeCategoriesSection = document.getElementById('watchmodeCategoriesSection');
        const watchmodeCategoriesGrid = document.getElementById('watchmodeCategoriesGrid');

        const searchResultsSection = document.getElementById('searchResultsSection');
        const searchResultsTitle = document.getElementById('searchResultsTitle');
        const searchResultsGrid = document.getElementById('searchResultsGrid');
        const sortResultsSelect = document.getElementById('sortResultsSelect');
        
        const favoritesSection = document.getElementById('favoritesSection');
        const favoritesTitle = document.getElementById('favoritesTitle');
        const favoritesGrid = document.getElementById('favoritesGrid');

        const homeLink = document.getElementById('homeLink');
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');
        const navDiscoverMobile = document.getElementById('navDiscoverMobile');
        const navFavoritesMobile = document.getElementById('navFavoritesMobile');
        const navDiscoverDesktop = document.getElementById('navDiscoverDesktop');
        const navFavoritesDesktop = document.getElementById('navFavoritesDesktop');

        let currentTvShow = { id: null, tmdb_id: null, name: null, season: 1, episode: 1, totalSeasons: 0, episodesInCurrentSeason: [] };
        let seasonDetailsCache = {}; 
        let currentSearchFilter = 'multi'; 
        let currentSearchResults = [];
        let currentSearchQuery = '';
        let originalBodyOverflow = '';
        let originalHtmlOverflow = ''; 
        let currentInfoModalData = null;
        let isAnyModalOpenForScrollLock = false;

        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'text-center my-4 h-6 ';
            if (type === 'error') statusMessage.classList.add('text-red-400');
            else if (type === 'success') statusMessage.classList.add('text-green-400');
            else statusMessage.classList.add('text-gray-400');
        }

        function createLoadingSpinner() {
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner'; 
            return spinner;
        }

        async function fetchFromTMDB(tmdbEndpoint, tmdbParams = {}) {
            const proxyUrlParams = new URLSearchParams({ endpoint: tmdbEndpoint, ...tmdbParams });
            const proxyUrl = `/api/tmdb-proxy?${proxyUrlParams.toString()}`;
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `TMDB API Error: ${response.status}` }));
                    throw new Error(errorData.message || `TMDB API Error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching from TMDB Proxy:', error);
                showStatus(error.message || "An unknown TMDB API error occurred.", 'error');
                throw error; 
            }
        }

        async function fetchFromWatchModeProxy(endpoint, params = {}) {
            const proxyUrlParams = new URLSearchParams({ endpoint, ...params });
            const proxyUrl = `${WATCHMODE_PROXY_URL}?${proxyUrlParams.toString()}`;
            try {
                const response = await fetch(proxyUrl);
                 if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `WatchMode API Error: ${response.status}` }));
                    throw new Error(errorData.message || `WatchMode API Error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching from WatchMode Proxy:', error);
                throw error;
            }
        }

        function createContentCard(item, type, source = 'tmdb') {
            const card = document.createElement('div');
            card.className = 'card';

            let title, posterPath, id, itemType, year = "";

            if (source === 'tmdb') {
                title = (item.title || item.name || item.original_name || "Untitled");
                posterPath = item.poster_path ? `${TMDB_IMG_BASE_URL}${item.poster_path}` : `https://placehold.co/180x270/1f1f1f/e50914?text=${encodeURIComponent(title.substring(0,15))}`;
                id = item.id;
                itemType = type;
                year = item.release_date ? item.release_date.substring(0,4) : (item.first_air_date ? item.first_air_date.substring(0,4) : "");
            } else if (source === 'watchmode') {
                title = item.title || "Untitled";
                posterPath = item.poster || `https://placehold.co/180x270/1f1f1f/e50914?text=${encodeURIComponent(title.substring(0,15))}`;
                id = item.tmdb_id || item.id;
                itemType = item.tmdb_type || item.type;
                if (itemType === 'tv_series') itemType = 'tv';
                if (itemType === 'short_film') itemType = 'movie';
                year = item.year || "";
            }

            const isFav = isFavorite(id, itemType);
            
            card.innerHTML = `
                <img src="${posterPath}" alt="${title} Poster" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/180x270/1f1f1f/e50914?text=No+Poster';">
                <div class="p-2">
                    <h4 class="font-semibold truncate text-sm" title="${title}">${title} ${year ? `(${year})` : ''}</h4>
                    <p class="text-xs text-gray-400">${itemType === 'movie' ? 'Movie' : 'TV Show'}</p>
                </div>
                <div class="favorite-icon ${isFav ? 'is-favorite' : ''}" data-id="${id}" data-type="${itemType}" data-title="${title}" data-poster="${source === 'tmdb' ? item.poster_path || '' : ''}">
                    <i class="${isFav ? 'fas' : 'far'} fa-heart"></i>
                </div>`;
            
            const effectiveId = source === 'watchmode' ? item.tmdb_id : id;
            const effectiveType = source === 'watchmode' ? (item.tmdb_type === 'tv_series' ? 'tv' : item.tmdb_type) : itemType;

            if (effectiveId && effectiveType) {
                 card.querySelector('img').addEventListener('click', () => openInfoModal(effectiveId, effectiveType));
                 card.querySelector('h4').addEventListener('click', () => openInfoModal(effectiveId, effectiveType));
            }

            const favIconEl = card.querySelector('.favorite-icon');
            favIconEl.addEventListener('click', (e) => {
                e.stopPropagation(); 
                const favData = {
                    id: parseInt(favIconEl.dataset.id),
                    type: favIconEl.dataset.type,
                    title: favIconEl.dataset.title, 
                    poster_path: favIconEl.dataset.poster
                };
                toggleFavorite(favData, favIconEl); 
            });
            return card;
        }
        
        async function loadTopRatedTMDBContent() {
            console.log("FUNC: loadTopRatedTMDBContent called");
            showStatus(''); 
            
            if (!tmdbMoviesScrollWrapper || !tmdbTvScrollWrapper) {
                console.error("TMDB scroll wrappers not found in loadTopRatedTMDBContent, reinitializing...");
                reinitializeScrollableContent(); 
                if (!tmdbMoviesScrollWrapper || !tmdbTvScrollWrapper) {
                    showStatus("UI elements missing for TMDB. Please refresh.", "error"); 
                    console.error("TMDB scroll wrappers STILL not found after reinit.");
                    return;
                }
            }

            tmdbMoviesScrollWrapper.innerHTML = ''; 
            tmdbTvScrollWrapper.innerHTML = '';
            const movieSpinner = createLoadingSpinner(); 
            const tvSpinner = createLoadingSpinner();
            tmdbMoviesScrollWrapper.appendChild(movieSpinner); 
            tmdbTvScrollWrapper.appendChild(tvSpinner);
            updateSpecificScrollButtons(tmdbMoviesScrollWrapper); 
            updateSpecificScrollButtons(tmdbTvScrollWrapper);

            try {
                console.log("Fetching TMDB top rated movies and TV shows...");
                const [moviesData, tvData] = await Promise.all([
                    fetchFromTMDB('movie/top_rated'), 
                    fetchFromTMDB('tv/top_rated')
                ]);
                console.log("TMDB Data Received:", { moviesData, tvData });

                tmdbMoviesScrollWrapper.innerHTML = '';
                if (moviesData && moviesData.results && moviesData.results.length > 0) {
                    moviesData.results.forEach(movie => tmdbMoviesScrollWrapper.appendChild(createContentCard(movie, 'movie', 'tmdb')));
                } else { 
                    console.log("No top rated movies found or error in data.");
                    tmdbMoviesScrollWrapper.innerHTML = '<p class="p-4 text-gray-400">Could not load top rated movies.</p>'; 
                }
                updateSpecificScrollButtons(tmdbMoviesScrollWrapper);

                tmdbTvScrollWrapper.innerHTML = '';
                if (tvData && tvData.results && tvData.results.length > 0) {
                    tvData.results.forEach(tvShow => tmdbTvScrollWrapper.appendChild(createContentCard(tvShow, 'tv', 'tmdb')));
                } else { 
                    console.log("No top rated TV shows found or error in data.");
                    tmdbTvScrollWrapper.innerHTML = '<p class="p-4 text-gray-400">Could not load top rated TV shows.</p>'; 
                }
                updateSpecificScrollButtons(tmdbTvScrollWrapper);
            } catch (error) {
                console.error("Error in loadTopRatedTMDBContent:", error);
                if (tmdbMoviesScrollWrapper.contains(movieSpinner)) {
                    tmdbMoviesScrollWrapper.innerHTML = `<p class="p-4 text-red-400">Error loading TMDB movies.</p>`;
                }
                if (tmdbTvScrollWrapper.contains(tvSpinner)) {
                    tmdbTvScrollWrapper.innerHTML = `<p class="p-4 text-red-400">Error loading TMDB TV shows.</p>`;
                }
            }
            updateAllFavoriteIcons();
        }

        async function loadStreamingServiceCategories() {
            console.log("FUNC: loadStreamingServiceCategories called");
            if (!watchmodeCategoriesGrid) {
                console.error("WatchMode categories grid not found.");
                return;
            }
            watchmodeCategoriesGrid.innerHTML = ''; 
            watchModeCategoryData = {}; 

            for (const source of WATCHMODE_SOURCES) {
                const categoryId = `watchmode-source-${source.id}`;
                const categoryDiv = document.createElement('div');
                categoryDiv.id = categoryId;
                categoryDiv.className = 'mb-10 category-container';
                categoryDiv.innerHTML = `
                    <h3 class="text-2xl font-semibold mb-4">${source.name}</h3>
                    <div class="horizontal-scroll-container">
                        <button class="scroll-button prev" data-target="${categoryId}-scroll"><i class="fas fa-chevron-left"></i></button>
                        <div id="${categoryId}-scroll" class="scroll-wrapper flex space-x-4">
                        </div>
                        <button class="scroll-button next" data-target="${categoryId}-scroll"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="text-center mt-2">
                        <button class="btn-show-more" data-source-id="${source.id}" data-page="1">Show More</button>
                    </div>
                `;
                watchmodeCategoriesGrid.appendChild(categoryDiv);
                const scrollWrapper = document.getElementById(`${categoryId}-scroll`);
                scrollWrapper.innerHTML = ''; 
                const spinner = createLoadingSpinner();
                scrollWrapper.appendChild(spinner); 
                updateSpecificScrollButtons(scrollWrapper);

                try {
                    console.log(`Fetching WatchMode titles for ${source.name} (ID: ${source.id})...`);
                    const params = {
                        source_ids: source.id,
                        types: "movie,tv_series", 
                        sort_by: "popularity_desc",
                        limit: 50 
                    };
                    const data = await fetchFromWatchModeProxy('list-titles', params);
                    console.log(`WatchMode data for ${source.name}:`, data);
                    
                    scrollWrapper.innerHTML = ''; 
                    if (data && data.titles && data.titles.length > 0) {
                        watchModeCategoryData[source.id] = {
                            titles: data.titles,
                            shownCount: 0,
                            sourceName: source.name
                        };
                        displayWatchModeTitles(source.id, scrollWrapper);
                    } else {
                        console.log(`No WatchMode titles found for ${source.name} or error in data.`);
                        scrollWrapper.innerHTML = `<p class="p-4 text-gray-400">No titles found for ${source.name} currently.</p>`;
                        const showMoreButton = categoryDiv.querySelector('.btn-show-more');
                        if(showMoreButton) showMoreButton.style.display = 'none';
                    }
                } catch (error) {
                    console.error(`Error loading WatchMode titles for ${source.name}:`, error);
                    if (scrollWrapper.contains(spinner)) {
                        scrollWrapper.innerHTML = `<p class="p-4 text-red-400">Error loading titles for ${source.name}.</p>`;
                    }
                    const showMoreButton = categoryDiv.querySelector('.btn-show-more');
                    if(showMoreButton) showMoreButton.style.display = 'none';
                }
            }
            reinitializeScrollableContent(); 
        }

        function displayWatchModeTitles(sourceId, scrollWrapperElement, loadMore = false) {
            const category = watchModeCategoryData[sourceId];
            if (!category) return;

            const titlesToShow = category.titles.slice(category.shownCount, category.shownCount + (loadMore ? WATCHMODE_ITEMS_TO_LOAD_ON_SHOW_MORE : WATCHMODE_ITEMS_PER_PAGE));
            
            titlesToShow.forEach(title => {
                const cardItem = {
                    id: title.id,
                    title: title.title,
                    year: title.year,
                    type: title.type,
                    poster: title.poster,
                    imdb_id: title.imdb_id,
                    tmdb_id: title.tmdb_id,
                    tmdb_type: title.tmdb_type
                };
                scrollWrapperElement.appendChild(createContentCard(cardItem, cardItem.type, 'watchmode'));
            });

            category.shownCount += titlesToShow.length;
            updateSpecificScrollButtons(scrollWrapperElement);
            updateAllFavoriteIcons();

            const showMoreButton = document.querySelector(`.btn-show-more[data-source-id="${sourceId}"]`);
            if (showMoreButton) {
                if (category.shownCount >= category.titles.length) {
                    showMoreButton.textContent = "No More Results";
                    showMoreButton.disabled = true;
                } else {
                    showMoreButton.textContent = "Show More";
                    showMoreButton.disabled = false;
                }
            }
        }
        
        watchmodeCategoriesGrid.addEventListener('click', function(event) {
            if (event.target.classList.contains('btn-show-more') && !event.target.disabled) {
                const sourceId = event.target.dataset.sourceId;
                const scrollWrapperId = `watchmode-source-${sourceId}-scroll`;
                const scrollWrapper = document.getElementById(scrollWrapperId);
                if (scrollWrapper) {
                    displayWatchModeTitles(sourceId, scrollWrapper, true);
                }
            }
        });

        function sortAndDisplayResults() {
            let resultsToDisplay = [...currentSearchResults];
            const sortBy = sortResultsSelect.value;

            resultsToDisplay.sort((a, b) => {
                if (sortBy === 'popularity.desc') {
                    return (b.popularity || 0) - (a.popularity || 0);
                } else if (sortBy === 'date.desc') {
                    const dateA = new Date(a.release_date || a.first_air_date || '1900-01-01');
                    const dateB = new Date(b.release_date || b.first_air_date || '1900-01-01');
                    return dateB - dateA;
                } else if (sortBy === 'date.asc') {
                    const dateA = new Date(a.release_date || a.first_air_date || '3000-01-01');
                    const dateB = new Date(b.release_date || b.first_air_date || '3000-01-01');
                    return dateA - dateB;
                }
                return 0;
            });

            searchResultsGrid.innerHTML = '';
            if (resultsToDisplay.length === 0 && currentSearchQuery) {
                searchResultsGrid.innerHTML = `<p class="col-span-full text-center text-gray-400">No results found for "${currentSearchQuery}".</p>`;
                return;
            }
            resultsToDisplay.forEach(item => {
                 searchResultsGrid.appendChild(createContentCard(item, item.media_type, 'tmdb'));
            });
            updateAllFavoriteIcons();
        }

        function displaySearchResultsUI(results, query) {
            discoverSection.classList.add('hidden');
            watchmodeCategoriesSection.classList.add('hidden');
            favoritesSection.classList.add('hidden');
            searchResultsSection.classList.remove('hidden');
            searchResultsTitle.textContent = `Search Results for "${query}"`;

            let processedResults = results.map(item => {
                if (currentSearchFilter === 'movie' && !item.media_type) {
                    return { ...item, media_type: 'movie' };
                } else if (currentSearchFilter === 'tv' && !item.media_type) {
                    return { ...item, media_type: 'tv' };
                }
                return item;
            });
            
            currentSearchResults = processedResults.filter(item => 
                (item.media_type === 'movie' || item.media_type === 'tv') && item.poster_path
            );
            
            sortResultsSelect.value = 'popularity.desc';
            sortAndDisplayResults();
        }

        async function executeSearch(query) {
            if (!query) return;
            currentSearchQuery = query; 
            showStatus('');

            discoverSection.classList.add('hidden');
            watchmodeCategoriesSection.classList.add('hidden');
            favoritesSection.classList.add('hidden');
            searchResultsSection.classList.remove('hidden');
            
            searchResultsTitle.textContent = `Searching for "${query}"...`;
            searchResultsGrid.innerHTML = '';
            searchResultsGrid.appendChild(createLoadingSpinner());

            let endpoint = 'search/multi';
            if (currentSearchFilter === 'movie') endpoint = 'search/movie';
            else if (currentSearchFilter === 'tv') endpoint = 'search/tv';
            
            try {
                const data = await fetchFromTMDB(endpoint, { query });
                displaySearchResultsUI(data.results || [], query);
            } catch (error) {
                searchResultsTitle.textContent = `Search Results`;
                searchResultsGrid.innerHTML = `<p class="col-span-full text-center text-red-400">Error during search. Please try again.</p>`;
            }
        }
        
        function loadFavorites() {
            showStatus('');
            discoverSection.classList.add('hidden');
            watchmodeCategoriesSection.classList.add('hidden');
            searchResultsSection.classList.add('hidden');
            favoritesSection.classList.remove('hidden');
            favoritesGrid.innerHTML = '';

            document.querySelectorAll('.nav-link.active').forEach(l => l.classList.remove('active'));
            navFavoritesDesktop.classList.add('active');
            if(navFavoritesMobile) navFavoritesMobile.classList.add('active');

            const favorites = getFavorites();
            if (favorites.length === 0) {
                favoritesGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">You have no favorites yet. Add some!</p>';
                return;
            }
            favorites.forEach(fav => {
                favoritesGrid.appendChild(createContentCard(fav, fav.type, 'tmdb'));
            });
            updateAllFavoriteIcons(); 
        }

        function getFavorites() { return JSON.parse(localStorage.getItem('skyeMovieFavorites')) || []; }
        function saveFavorites(favorites) {
            localStorage.setItem('skyeMovieFavorites', JSON.stringify(favorites));
            updateAllFavoriteIcons(); 
        }
        function isFavorite(id, type) {
            const favorites = getFavorites();
            return favorites.some(fav => fav.id === parseInt(id) && fav.type === type);
        }
        function addToFavorites(item) {
            const favorites = getFavorites();
            if (!isFavorite(item.id, item.type)) {
                favorites.push({
                    id: parseInt(item.id), 
                    type: item.type, 
                    title: item.title || item.name || "Untitled", 
                    poster_path: item.poster_path || ''
                });
                saveFavorites(favorites);
            }
        }
        function removeFromFavorites(id, type) {
            let favorites = getFavorites();
            favorites = favorites.filter(fav => !(fav.id === parseInt(id) && fav.type === type));
            saveFavorites(favorites);
        }
        function toggleFavorite(itemData, iconContainerElement) { 
            const favObject = {
                id: parseInt(itemData.id),
                type: itemData.type,
                title: itemData.title,
                poster_path: itemData.poster_path
            };

            const iconElement = iconContainerElement ? iconContainerElement.querySelector('i') : null;

            if (isFavorite(favObject.id, favObject.type)) {
                removeFromFavorites(favObject.id, favObject.type);
                if(iconElement) {
                    iconElement.classList.remove('fas'); iconElement.classList.add('far');
                }
                if(iconContainerElement) iconContainerElement.classList.remove('is-favorite');
            } else {
                addToFavorites(favObject);
                if(iconElement) {
                    iconElement.classList.remove('far'); iconElement.classList.add('fas');
                }
                 if(iconContainerElement) iconContainerElement.classList.add('is-favorite');
            }
            updateInfoModalFavoriteButton(favObject.id, favObject.type); 
            if (!favoritesSection.classList.contains('hidden')) {
                loadFavorites();
            }
        }
        
        function updateAllFavoriteIcons() {
            document.querySelectorAll('.favorite-icon').forEach(iconContainerEl => {
                const id = parseInt(iconContainerEl.dataset.id);
                const type = iconContainerEl.dataset.type;
                const icon = iconContainerEl.querySelector('i');
                if (isFavorite(id, type)) {
                    icon.classList.remove('far'); icon.classList.add('fas');
                    iconContainerEl.classList.add('is-favorite');
                } else {
                    icon.classList.remove('fas'); icon.classList.add('far');
                    iconContainerEl.classList.remove('is-favorite');
                }
            });
        }
        
        async function openInfoModal(tmdbId, type) {
            showStatus("Loading details...", "info");
            try {
                const details = await fetchFromTMDB(`${type}/${tmdbId}`);
                showStatus("");
                currentInfoModalData = { ...details, type: type, id: tmdbId }; 

                infoModalTitle.textContent = details.title || details.name || "Details";
                infoModalPoster.src = details.poster_path ? `${TMDB_IMG_BASE_URL}${details.poster_path}` : 'https://placehold.co/150x225/1f1f1f/e50914?text=No+Poster';
                infoModalRating.textContent = details.vote_average ? `${details.vote_average.toFixed(1)}/10 (${details.vote_count} votes)` : "N/A";
                infoModalReleaseDate.textContent = details.release_date || details.first_air_date || "N/A";
                infoModalGenres.textContent = details.genres && details.genres.length > 0 ? details.genres.map(g => g.name).join(', ') : "N/A";
                infoModalOverview.textContent = details.overview || "No overview available.";

                updateInfoModalFavoriteButton(tmdbId, type);

                if (type === 'tv') {
                    infoModalTvControls.classList.remove('hidden');
                    currentTvShow.id = null;
                    currentTvShow.tmdb_id = tmdbId; 
                    currentTvShow.name = details.name || details.original_name;
                    currentTvShow.season = 1; 
                    currentTvShow.episode = 1; 
                    currentTvShow.totalSeasons = details.number_of_seasons;
                    
                    let validSeasons = details.seasons.filter(s => s.season_number > 0 && s.episode_count > 0);
                    if (validSeasons.length === 0 && details.seasons.length > 0) validSeasons = details.seasons.filter(s => s.episode_count > 0);
                    
                    populateDropdown(infoModalSeasonSelect, validSeasons, 'season_number', 'name', 'S');
                    if (validSeasons.length > 0) {
                        infoModalSeasonSelect.value = currentTvShow.season; 
                        await fetchEpisodesForInfoModalSeason(tmdbId, currentTvShow.season);
                    } else {
                        infoModalSeasonSelect.innerHTML = '<option>N/A</option>';
                        infoModalEpisodeSelect.innerHTML = '<option>N/A</option>';
                    }
                } else {
                    infoModalTvControls.classList.add('hidden');
                }
                openModal(infoModal);
            } catch (error) {
                showStatus("Failed to load details.", "error");
            }
        }

        async function fetchEpisodesForInfoModalSeason(tmdbTvId, seasonNumber) {
            infoModalEpisodeSelect.disabled = true; infoModalEpisodeSelect.innerHTML = '<option>Loading...</option>';
            const cacheKey = `tmdb-${tmdbTvId}-${seasonNumber}-info`; 
            try {
                let seasonDetails;
                if (seasonDetailsCache[cacheKey]) seasonDetails = seasonDetailsCache[cacheKey];
                else { seasonDetails = await fetchFromTMDB(`tv/${tmdbTvId}/season/${seasonNumber}`); seasonDetailsCache[cacheKey] = seasonDetails; }
                
                const episodes = seasonDetails.episodes || [];
                populateDropdown(infoModalEpisodeSelect, episodes, 'episode_number', 'name', 'E');
                if (episodes.length > 0) {
                    infoModalEpisodeSelect.value = 1; 
                    currentTvShow.episode = 1; 
                }
                infoModalEpisodeSelect.disabled = false;
            } catch (error) { infoModalEpisodeSelect.innerHTML = '<option>Error</option>'; }
        }
        
        infoModalSeasonSelect.addEventListener('change', async () => {
            if (!currentInfoModalData || currentInfoModalData.type !== 'tv') return;
            currentTvShow.season = parseInt(infoModalSeasonSelect.value);
            currentTvShow.episode = 1; 
            await fetchEpisodesForInfoModalSeason(currentInfoModalData.id, currentTvShow.season);
        });

        infoModalEpisodeSelect.addEventListener('change', () => {
            if (!currentInfoModalData || currentInfoModalData.type !== 'tv') return;
            currentTvShow.episode = parseInt(infoModalEpisodeSelect.value);
        });

        infoModalFavoriteButton.addEventListener('click', () => {
            if (currentInfoModalData) {
                toggleFavorite(currentInfoModalData);
            }
        });

        function updateInfoModalFavoriteButton(id, type) {
            if (infoModal.style.display === 'block' && currentInfoModalData && parseInt(currentInfoModalData.id) === parseInt(id) && currentInfoModalData.type === type) {
                if (isFavorite(id, type)) {
                    infoModalFavoriteButton.innerHTML = '<i class="fas fa-heart mr-2"></i>Remove from Favorites';
                    infoModalFavoriteButton.classList.add('is-favorite'); 
                } else {
                    infoModalFavoriteButton.innerHTML = '<i class="far fa-heart mr-2"></i>Add to Favorites';
                    infoModalFavoriteButton.classList.remove('is-favorite');
                }
            }
        }

        infoModalPlayButton.addEventListener('click', () => {
            if (!currentInfoModalData) return;
            const playData = { ...currentInfoModalData };
            closeModal(infoModal); 
            
            setTimeout(() => {
                if (playData.type === 'movie') {
                    playMovie(playData.id, playData.title || playData.original_name);
                } else if (playData.type === 'tv') {
                    currentTvShow.tmdb_id = playData.id;
                    currentTvShow.name = playData.name || playData.original_name;
                    currentTvShow.season = parseInt(infoModalSeasonSelect.value) || 1;
                    currentTvShow.episode = parseInt(infoModalEpisodeSelect.value) || 1;
                    updateAndShowTVControlsInPlayerModal(); 
                    playTvShow();
                }
            }, 50); 
        });
        
        async function updateAndShowTVControlsInPlayerModal() { 
            if (!currentTvShow.tmdb_id) { modalTvControls.classList.add('hidden'); return; }
            modalTvShowTitleEl.textContent = currentTvShow.name || 'Selected TV Show';
            modalTvControls.classList.remove('hidden');
            modalSeasonSelect.disabled = true; modalEpisodeSelect.disabled = true;
            modalSeasonSelect.innerHTML = '<option>Loading...</option>'; modalEpisodeSelect.innerHTML = '<option>Loading...</option>';
            nextEpisodeButton.disabled = true;
            try {
                const tvDetails = await fetchFromTMDB(`tv/${currentTvShow.tmdb_id}`);
                currentTvShow.totalSeasons = tvDetails.number_of_seasons;
                let validSeasons = tvDetails.seasons.filter(s => s.season_number > 0 && s.episode_count > 0);
                if (validSeasons.length === 0 && tvDetails.seasons.length > 0) validSeasons = tvDetails.seasons.filter(s => s.episode_count > 0); 
                populateDropdown(modalSeasonSelect, validSeasons, 'season_number', 'name', 'S');
                
                const seasonToSelect = validSeasons.find(s => s.season_number === currentTvShow.season) ? currentTvShow.season : (validSeasons.length > 0 ? validSeasons[0].season_number : null);
                if (seasonToSelect !== null) {
                    modalSeasonSelect.value = seasonToSelect;
                    currentTvShow.season = seasonToSelect;
                } else {
                     modalSeasonSelect.innerHTML = '<option>N/A</option>';
                }
                modalSeasonSelect.disabled = false;
                await fetchEpisodesForPlayerModalSeason(currentTvShow.tmdb_id, currentTvShow.season); 
            } catch (error) { 
                modalSeasonSelect.innerHTML = '<option>Error</option>'; 
                modalEpisodeSelect.innerHTML = '<option>Error</option>'; 
                console.error("Error updating TV controls in player modal:", error);
            }
        }
        
        async function fetchEpisodesForPlayerModalSeason(tmdbTvId, seasonNumber) { 
            modalEpisodeSelect.disabled = true; modalEpisodeSelect.innerHTML = '<option>Loading...</option>';
            nextEpisodeButton.disabled = true; 
            const cacheKey = `tmdb-${tmdbTvId}-${seasonNumber}-player`; 
            try {
                let seasonDetails;
                if (seasonDetailsCache[cacheKey]) seasonDetails = seasonDetailsCache[cacheKey];
                else { seasonDetails = await fetchFromTMDB(`tv/${tmdbTvId}/season/${seasonNumber}`); seasonDetailsCache[cacheKey] = seasonDetails; }
                currentTvShow.episodesInCurrentSeason = seasonDetails.episodes || [];
                populateDropdown(modalEpisodeSelect, currentTvShow.episodesInCurrentSeason, 'episode_number', 'name', 'E');
                
                const episodeToSelect = currentTvShow.episodesInCurrentSeason.find(ep => ep.episode_number === currentTvShow.episode) ? currentTvShow.episode : (currentTvShow.episodesInCurrentSeason.length > 0 ? currentTvShow.episodesInCurrentSeason[0].episode_number : null);

                if (episodeToSelect !== null) {
                    modalEpisodeSelect.value = episodeToSelect;
                    currentTvShow.episode = episodeToSelect;
                } else {
                     modalEpisodeSelect.innerHTML = '<option>N/A</option>';
                }
                modalEpisodeSelect.disabled = false; 
                updateNextEpisodeButtonState();
            } catch (error) { 
                modalEpisodeSelect.innerHTML = '<option>Error</option>'; 
                console.error("Error fetching episodes for player modal season:", error);
            }
        }

        function populateDropdown(selectEl, items, valueKey, textKey, prefix = '') {
            selectEl.innerHTML = '';
            if (!items || items.length === 0) { selectEl.innerHTML = `<option value="">N/A</option>`; return; }
            items.forEach(item => {
                const option = document.createElement('option'); option.value = item[valueKey];
                option.textContent = `${prefix}${item[valueKey]}${item[textKey] && item[textKey] !== `Episode ${item[valueKey]}` && item[textKey] !== `Season ${item[valueKey]}` ? `: ${item[textKey]}` : ''}`;
                selectEl.appendChild(option);
            });
        }

        function updateNextEpisodeButtonState() {
            if (!currentTvShow.tmdb_id || currentTvShow.episodesInCurrentSeason.length === 0) { nextEpisodeButton.disabled = true; return; }
            const currentEpisodeIndex = currentTvShow.episodesInCurrentSeason.findIndex(ep => ep.episode_number === currentTvShow.episode);
            const isLastEpisodeInSeason = currentEpisodeIndex === currentTvShow.episodesInCurrentSeason.length - 1;
            const isLastSeason = currentTvShow.season === currentTvShow.totalSeasons;
            nextEpisodeButton.disabled = isLastEpisodeInSeason && isLastSeason;
        }
        
        function playMovie(tmdbMovieId, title) {
            modalTvControls.classList.add('hidden'); 
            const playerProxyUrl = `${SUPEREMBED_PLAYER_PROXY_URL}?video_id=${tmdbMovieId}&tmdb=1&autoplay=1`;
            playerModalTitle.textContent = title || 'Movie'; 
            loadPlayer(playerProxyUrl);
        }

        function playTvShow() {
            if (!currentTvShow.tmdb_id) return;
            modalTvControls.classList.remove('hidden'); 
            const playerProxyUrl = `${SUPEREMBED_PLAYER_PROXY_URL}?video_id=${currentTvShow.tmdb_id}&tmdb=1&season=${currentTvShow.season}&episode=${currentTvShow.episode}&autoplay=1`;
            playerModalTitle.textContent = `${currentTvShow.name || 'TV Show'} (S${currentTvShow.season} E${currentTvShow.episode})`;
            loadPlayer(playerProxyUrl); 
            updateNextEpisodeButtonState(); 
        }

        function openModal(modalElement) {
            if (!isAnyModalOpenForScrollLock) {
                originalBodyOverflow = document.body.style.overflow;
                originalHtmlOverflow = document.documentElement.style.overflow;
                document.documentElement.style.overflow = 'hidden';
                document.body.style.overflow = 'hidden';
                isAnyModalOpenForScrollLock = true;
            }
            modalElement.style.display = "block";
        }

        function closeModal(modalElement) {
            modalElement.style.display = "none";
            if (modalElement === playerModal) playerContainer.innerHTML = ""; 
            
            if (infoModal.style.display === 'none' && playerModal.style.display === 'none') {
                 if (isAnyModalOpenForScrollLock) {
                    document.documentElement.style.overflow = originalHtmlOverflow;
                    document.body.style.overflow = originalBodyOverflow;
                    isAnyModalOpenForScrollLock = false;
                 }
            }
            if (modalElement === playerModal) modalTvControls.classList.add('hidden'); 
        }

        function loadPlayer(proxyUrl) {
            playerContainer.innerHTML = ''; 
            const iframe = document.createElement('iframe');
            iframe.src = proxyUrl;
            
            iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-modals allow-fullscreen allow-autoplay allow-presentation');
            iframe.setAttribute('allow', 'fullscreen; autoplay; encrypted-media; picture-in-picture');
            iframe.setAttribute('allowfullscreen', ''); 
            iframe.style.border = '0';

            playerContainer.appendChild(iframe);

            iframe.onload = function() {
                if (playerContainer.contains(iframe) && iframe.contentWindow) {
                    try { iframe.focus(); } catch (e) { }
                }
            };
            iframe.onerror = function() {
                playerContainer.innerHTML = '<p style="color:red; text-align:center; padding:20px;">Player failed to load. The proxy or embed source may be down.</p>';
            };
            openModal(playerModal);
        }

        closeInfoModalButton.addEventListener('click', () => closeModal(infoModal));
        closePlayerModalButton.addEventListener('click', () => closeModal(playerModal));

        window.addEventListener('click', (event) => { 
            if (event.target === playerModal) closeModal(playerModal); 
            if (event.target === infoModal) closeModal(infoModal);
        });
        window.addEventListener('keydown', (event) => { 
            if (event.key === 'Escape') {
                if (playerModal.style.display === 'block') closeModal(playerModal);
                else if (infoModal.style.display === 'block') closeModal(infoModal);
            }
        });
        
        function setSearchFilter(filterType, filterButtonContainer) {
            currentSearchFilter = filterType;
            filterButtonContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            filterButtonContainer.querySelector(`.filter-btn[data-filter="${filterType}"]`).classList.add('active');
        }

        [desktopSearchFilters, mobileSearchFilters].forEach(container => {
            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    const filterType = e.target.dataset.filter;
                    setSearchFilter(filterType, desktopSearchFilters); 
                    setSearchFilter(filterType, mobileSearchFilters);
                    const query = desktopSearchInput.value.trim() || mobileSearchInput.value.trim();
                    if (!searchResultsSection.classList.contains('hidden') && query) { 
                        executeSearch(query);
                    }
                }
            });
        });
        
        desktopSearchButton.addEventListener('click', () => { executeSearch(desktopSearchInput.value.trim()); });
        desktopSearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') executeSearch(desktopSearchInput.value.trim()); });
        mobileSearchButton.addEventListener('click', () => { 
            const query = mobileSearchInput.value.trim();
            if (query) { executeSearch(query); if (mobileMenu) mobileMenu.classList.add('hidden');}
        });
        mobileSearchInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') {
                const query = mobileSearchInput.value.trim();
                if (query) { executeSearch(query); if (mobileMenu) mobileMenu.classList.add('hidden'); }
            }
        });
        sortResultsSelect.addEventListener('change', sortAndDisplayResults);

        modalSeasonSelect.addEventListener('change', async () => {
            currentTvShow.season = parseInt(modalSeasonSelect.value); 
            currentTvShow.episode = 1;
            await fetchEpisodesForPlayerModalSeason(currentTvShow.tmdb_id, currentTvShow.season); 
            if(modalEpisodeSelect.options.length > 0 && modalEpisodeSelect.value && parseInt(modalEpisodeSelect.value) > 0) {
                 playTvShow(); 
            }
        });
        modalEpisodeSelect.addEventListener('change', () => { 
            currentTvShow.episode = parseInt(modalEpisodeSelect.value); 
            if (currentTvShow.episode > 0) playTvShow(); 
        });
        nextEpisodeButton.addEventListener('click', async () => {
            if (!currentTvShow.tmdb_id || nextEpisodeButton.disabled) return;
            const currentEpisodeIndex = currentTvShow.episodesInCurrentSeason.findIndex(ep => ep.episode_number === currentTvShow.episode);
            if (currentEpisodeIndex !== -1 && currentEpisodeIndex < currentTvShow.episodesInCurrentSeason.length - 1) {
                currentTvShow.episode = currentTvShow.episodesInCurrentSeason[currentEpisodeIndex + 1].episode_number;
                modalEpisodeSelect.value = currentTvShow.episode;
            } else if (currentTvShow.season < currentTvShow.totalSeasons) {
                currentTvShow.season++; 
                currentTvShow.episode = 1;
                modalSeasonSelect.value = currentTvShow.season;
            }
        });

        function reinitializeScrollableContent() {
            tmdbMoviesScrollWrapper = document.getElementById('tmdbMoviesScrollWrapper');
            tmdbTvScrollWrapper = document.getElementById('tmdbTvScrollWrapper');
            const tmdbScrollButtons = document.querySelectorAll('#tmdbMoviesContainer .scroll-button, #tmdbTvShowsContainer .scroll-button');
            tmdbScrollButtons.forEach(button => {
                button.removeEventListener('click', handleScrollButtonClick); 
                button.addEventListener('click', handleScrollButtonClick);
            });
            if(tmdbMoviesScrollWrapper) {
                tmdbMoviesScrollWrapper.removeEventListener('scroll', updateSpecificScrollButtons);
                tmdbMoviesScrollWrapper.addEventListener('scroll', () => updateSpecificScrollButtons(tmdbMoviesScrollWrapper), { passive: true });
                updateSpecificScrollButtons(tmdbMoviesScrollWrapper);
            }
            if(tmdbTvScrollWrapper) {
                tmdbTvScrollWrapper.removeEventListener('scroll', updateSpecificScrollButtons);
                tmdbTvScrollWrapper.addEventListener('scroll', () => updateSpecificScrollButtons(tmdbTvScrollWrapper), { passive: true });
                updateSpecificScrollButtons(tmdbTvScrollWrapper);
            }

            document.querySelectorAll('#watchmodeCategoriesGrid .horizontal-scroll-container').forEach(container => {
                const scrollWrapper = container.querySelector('.scroll-wrapper');
                const scrollButtons = container.querySelectorAll('.scroll-button');
                if (scrollWrapper) {
                    scrollButtons.forEach(button => {
                        button.removeEventListener('click', handleScrollButtonClick);
                        button.addEventListener('click', handleScrollButtonClick);
                    });
                    scrollWrapper.removeEventListener('scroll', updateSpecificScrollButtons);
                    scrollWrapper.addEventListener('scroll', () => updateSpecificScrollButtons(scrollWrapper), { passive: true });
                    updateSpecificScrollButtons(scrollWrapper);
                }
            });
        }
        
        function updateSpecificScrollButtons(scrollWrapper) {
            if (!scrollWrapper || !scrollWrapper.parentElement) return;
            const prevButton = scrollWrapper.parentElement.querySelector('.scroll-button.prev');
            const nextButton = scrollWrapper.parentElement.querySelector('.scroll-button.next');
            if(!prevButton || !nextButton) return;
            
            const isScrollable = scrollWrapper.scrollWidth > scrollWrapper.clientWidth + 1; 
            
            if (!isScrollable) {
                prevButton.style.display = 'none';
                nextButton.style.display = 'none';
                return;
            }
            prevButton.style.display = 'block';
            nextButton.style.display = 'block';
            
            prevButton.disabled = scrollWrapper.scrollLeft <= 0;
            nextButton.disabled = scrollWrapper.scrollLeft + scrollWrapper.clientWidth >= scrollWrapper.scrollWidth - 5; 
        }
        
        function handleScrollButtonClick(event) {
            const button = event.currentTarget; 
            const targetId = button.dataset.target;
            const scrollWrapper = document.getElementById(targetId); 
            if (!scrollWrapper) return;
            const scrollAmount = scrollWrapper.clientWidth * 0.8; 
            if (button.classList.contains('next')) scrollWrapper.scrollLeft += scrollAmount;
            else if (button.classList.contains('prev')) scrollWrapper.scrollLeft -= scrollAmount;
        }
        
        homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            desktopSearchInput.value = ''; mobileSearchInput.value = '';
            showDiscoverView();
        });
        
        if (mobileMenuButton && mobileMenu) {
            mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
        }
        if (navDiscoverMobile) {
            navDiscoverMobile.addEventListener('click', (e) => { 
                e.preventDefault(); 
                if (mobileMenu) mobileMenu.classList.add('hidden'); 
                showDiscoverView(); 
            });
        }
        if (navFavoritesMobile) {
            navFavoritesMobile.addEventListener('click', (e) => { 
                e.preventDefault(); 
                if (mobileMenu) mobileMenu.classList.add('hidden'); 
                loadFavorites(); 
            });
        }
        navDiscoverDesktop.addEventListener('click', (e) => { e.preventDefault(); showDiscoverView(); });
        navFavoritesDesktop.addEventListener('click', (e) => { e.preventDefault(); loadFavorites(); });

        function showDiscoverView() {
            console.log("FUNC: showDiscoverView called");
            showStatus('');
            contentAreaTitle.textContent = "Discover";
            discoverSection.classList.remove('hidden');
            watchmodeCategoriesSection.classList.remove('hidden');
            searchResultsSection.classList.add('hidden');
            favoritesSection.classList.add('hidden');

            document.querySelectorAll('.nav-link.active').forEach(l => l.classList.remove('active'));
            navDiscoverDesktop.classList.add('active');
            if (navDiscoverMobile) navDiscoverMobile.classList.add('active');
            
            let tmdbContentLoaded = tmdbMoviesScrollWrapper && tmdbMoviesScrollWrapper.children.length > 0 && !(tmdbMoviesScrollWrapper.firstChild && tmdbMoviesScrollWrapper.firstChild.classList.contains('loading-spinner'));
            let watchmodeContentLoaded = watchmodeCategoriesGrid && watchmodeCategoriesGrid.children.length > 0 && !(watchmodeCategoriesGrid.firstChild && watchmodeCategoriesGrid.firstChild.querySelector('.loading-spinner'));


            if (!tmdbContentLoaded) {
                console.log("Loading TMDB Top Rated Content in showDiscoverView...");
                loadTopRatedTMDBContent();
            } else {
                console.log("TMDB Top Rated Content already loaded or loading.");
            }
            if (!watchmodeContentLoaded) {
                 console.log("Loading WatchMode Categories in showDiscoverView...");
                 loadStreamingServiceCategories();
            } else {
                console.log("WatchMode Categories already loaded or loading.");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("EVENT: DOMContentLoaded");
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            showDiscoverView();
            reinitializeScrollableContent();
            updateAllFavoriteIcons(); 
        });

    </script>
</body>
</html>
